# Архитектура приложения "Йога Практика"

## Общее описание
Приложение "Йога Практика" - это Telegram Mini App, предназначенное для обучения йоге, отслеживания прогресса, и организации практик. Приложение интегрируется с Telegram SDK для получения данных пользователя и предлагает персонализированный опыт практики йоги.

## Технологический стек
- **Frontend**: Next.js 14, React, TypeScript
- **Стилизация**: Tailwind CSS
- **Хранение данных**: Supabase (PostgreSQL)
- **Аутентификация**: Supabase Auth + Telegram authentication
- **Инфраструктура**: Vercel (деплой и хостинг)
- **SDK**: Telegram Mini Apps SDK

## Основные компоненты системы

### Модули клиентской части
1. **Auth**: Система аутентификации с интеграцией Telegram
2. **Navigation**: Навигация между экранами приложения
3. **User Profile**: Управление профилем пользователя
4. **Yoga Practice**: Модуль для практики йоги
5. **Statistics**: Модуль отслеживания статистики
6. **Schedule**: Модуль расписания занятий
7. **Library**: Библиотека материалов по йоге

### Структура файлов
```
/src
  /app                 # Pages using App Router
  /components          # React компоненты
    /screens           # Экраны приложения
    /Debug             # Отладочные компоненты
  /context             # React контексты
  /hooks               # React хуки
  /lib                 # Утилиты и библиотеки
/public                # Статические ресурсы
/docs                  # Документация
```

## Интеграции

### Telegram Mini Apps SDK
- **Инициализация**: Использование SDK для получения данных пользователя и инициализации приложения
- **UI адаптация**: Адаптация интерфейса под требования Telegram Mini Apps
- **Fullscreen режим**: Использование web_app_request_fullscreen для оптимизации отображения
- **Content Safe Area**: Применение отступов для корректного отображения на разных устройствах

### Supabase
- **Таблицы**:
  - `auth.users`: Управление пользователями
  - `public.users`: Публичные данные пользователей
  - `logs`: Логи приложения 
  - `user_stats`: Статистика пользователей
  - `user_settings`: Настройки пользователей

## Архитектурные решения

### Модульность
- Компоненты разделены на маленькие, переиспользуемые блоки
- Максимальный размер компонента - 400-700 строк
- При превышении лимита компонент разбивается на более мелкие части

### Авторизация
- Интеграция с Telegram:
  - Получение данных пользователя через retrieveLaunchParams()
  - Сохранение данных в Supabase
- Использование TelegramContext для управления данными пользователя
- Синхронизация Telegram user и Supabase user

### Отладка
- Компонент DebugPanel для отладки приложения
- Логирование действий в консоль и в Supabase
- Возможность просмотра логов через панель отладки

## Основные пользовательские потоки

### Авторизация
1. Пользователь открывает приложение в Telegram
2. Приложение получает данные пользователя через Telegram SDK
3. Данные сохраняются в Supabase
4. Создается запись в таблице users и user_settings

### Выбор и выполнение практики
1. Пользователь выбирает практику на главном экране
2. Открывается экран выбора практики
3. После выбора отображается выбранная практика
4. После завершения практики обновляется статистика

## База данных

### Схема базы данных
- **auth.users**: Системная таблица Supabase для пользователей
- **public.users**: 
  - id (FK к auth.users)
  - telegram_id
  - first_name
  - last_name
  - username
  - photo_url
  - created_at
  - updated_at
  - last_login
- **user_stats**:
  - id
  - user_id (FK к users)
  - total_minutes
  - sessions_completed
  - streak
  - level
  - created_at
  - updated_at
- **logs**:
  - id
  - user_id
  - level (info, error, warn, debug)
  - message
  - data
  - created_at

## Деплой

### Vercel
- Автоматический деплой при пуше в main
- Переменные окружения настроены для Next.js + Supabase
- Настроена интеграция с GitHub

### Переменные окружения
- `NEXT_PUBLIC_SUPABASE_URL` - URL Supabase проекта
- `NEXT_PUBLIC_SUPABASE_ANON_KEY` - Публичный ключ Supabase
- `NEXT_PUBLIC_IGNORE_BUILD_ERROR` - Игнорировать ошибки сборки
- `NEXT_PUBLIC_API_URL` - URL API (если необходимо)

## Разработка и тестирование

### Локальная разработка
- `npm run dev` - запуск локального сервера
- `npm run lint` - запуск линтера

### Тестирование
- CLI-скрипты для тестирования интеграции с Supabase
- Отладочная панель для мониторинга состояния приложения

## Будущие улучшения
- Расширение библиотеки материалов
- Добавление возможности создания своих практик
- Интеграция с другими платформами
- Улучшение отслеживания прогресса

## Структура файлов
```
w_ivan
├── .env                   # Переменные окружения 
├── .env.local             # Локальные переменные окружения
├── .gitignore             # Исключения для Git
├── next.config.js         # Конфигурация Next.js
├── package.json           # Зависимости проекта
├── tailwind.config.ts     # Конфигурация Tailwind CSS
├── tsconfig.json          # Конфигурация TypeScript
├── docs/                  # Документация
│   ├── SHORT_PLANNING.md  # Краткосрочный план
│   ├── TASK.md            # Задачи проекта
│   └── architecture.md    # Описание архитектуры
├── public/                # Публичные файлы
└── src/                   # Исходный код
    ├── app/               # Страницы Next.js App Router
    │   ├── auth/          # Страницы аутентификации
    │   ├── library/       # Страницы библиотеки
    │   ├── practice/      # Страницы практик
    │   ├── profile/       # Страницы профиля
    │   ├── schedule/      # Страницы расписания
    │   └── page.tsx       # Главная страница
    ├── components/        # Компоненты React
    │   ├── AppNavigation.tsx          # Компонент навигации
    │   ├── FloatingDebugButton.tsx    # Кнопка отладки
    │   ├── MainContent.tsx            # Основной контент
    │   ├── RecommendedPractices.tsx   # Рекомендуемые практики
    │   ├── StatisticsCard.tsx         # Карточка статистики
    │   ├── Debug/                     # Компоненты отладки
    │   │   ├── DebugPanel.tsx         # Панель отладки
    │   │   └── tabs/                  # Вкладки панели отладки
    │   └── screens/                   # Экраны приложения
    │       ├── HomeScreen.tsx         # Экран главной страницы
    │       ├── LibraryScreen.tsx      # Экран библиотеки
    │       ├── ProfileScreen.tsx      # Экран профиля
    │       ├── ScheduleScreen.tsx     # Экран расписания
    │       └── PracticeSelectionScreen.tsx # Экран выбора практики
    ├── context/                        # React контексты
    │   ├── AuthContext.tsx            # Контекст аутентификации
    │   └── TelegramContext.tsx        # Контекст Telegram
    ├── hooks/                          # React хуки
    │   ├── useUserStats.ts            # Хук статистики пользователя
    │   └── useSupabase.ts             # Хук для работы с Supabase
    └── lib/                            # Библиотеки и утилиты
        ├── logger.ts                   # Система логирования
        └── supabase.ts                 # Клиент Supabase
```

## Последняя верификация
- **Дата**: 13.11.2024
- **Время**: 22:15
- **Автор**: Dev Team
- **Статус**: Актуально