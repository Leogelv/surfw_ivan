# Архитектура проекта

## Верхнеуровневая архитектура
- Приложение для практик (медитативных, дыхательных, телесных) на Next.js
- Система авторизации и аутентификации на базе Supabase Auth
- Квиз для подбора практик начинается с кнопки "Выбрать практику" на главной странице
- Единый плеер с поддержкой трех режимов: медитация с таймером, медитация с аудио, видео
- Интеграция с Supabase для хранения логики квиза, данных пользователя и прогресса
- Клиентская часть на React 19, TypeScript и Tailwind CSS

## Среднеуровневые компоненты
- **Страницы**: 
  - Главная страница (/) с кнопкой "Выбрать практику"
  - Страницы авторизации (/auth/login, /auth/register, /auth/reset-password)
  - Страница профиля пользователя (/profile)
- **Компоненты авторизации**:
  - AuthForms/ - формы авторизации
    - LoginForm - форма входа
    - RegisterForm - форма регистрации
    - ResetPasswordForm - форма восстановления пароля
  - Profile/ - компоненты профиля пользователя
    - ProfileInfo - информация о пользователе
    - ProfileSettings - настройки пользователя
    - ProfileStats - статистика пользователя
- **Компоненты квиза**: 
  - PracticeSelectionScreen - выбор типа практики (До 7 мин, Телесная, Дыхательная, Медитация)
  - HowItWorksScreen - информация о работе квиза
  - **Ветка "До 7 мин"**:
    - ShortPracticeGoalScreen - выбор цели для короткой практики
  - **Ветка "Телесная практика"**:
    - PhysicalTimeScreen - выбор длительности телесной практики
    - ShortPhysicalGoalScreen - выбор цели для короткой телесной практики
    - LongPhysicalGoalScreen - выбор цели для длинной телесной практики
  - **Ветка "Дыхательная практика"**:
    - BreathingGoalScreen - выбор цели для дыхательной практики
  - **Ветка "Медитация"**:
    - MeditationApproachScreen - выбор подхода к медитации
    - SelfGuidedTimePicker - выбор времени для самостоятельной медитации
    - ConcentrationObjectScreen - выбор объекта концентрации
    - GuidedMeditationThemeScreen - выбор темы для медитации с сопровождением
    - GuidedMeditationGoalScreen - выбор цели для медитации с сопровождением
- **Компоненты плеера**:
  - Player - универсальный плеер для всех типов практик
  - MeditationTimerMode - режим медитаций с таймером (для самостоятельной)
  - MeditationAudioMode - режим медитаций с аудио (с сопровождением)
  - VideoMode - режим видео с контентом (для телесных и дыхательных)
- **Контексты**: 
  - AuthContext - контекст для управления авторизацией
  - QuizContext - контекст для хранения состояния квиза
  - PlayerContext - контекст для управления плеером

## Структура базы данных (Supabase)
- **Таблица users** (управление пользователями):
  - `id` - уникальный идентификатор (связан с auth.users)
  - `username` - имя пользователя
  - `telegram_id` - ID пользователя в Telegram
  - `avatar_url` - URL аватара пользователя
  - `preferences` - предпочтения пользователя (JSON)
  - `created_at` - дата создания
  - `updated_at` - дата обновления
  - `first_name` - имя пользователя
  - `last_name` - фамилия пользователя
  - `last_login` - дата последнего входа
  - `photo_url` - URL фото профиля

- **Таблица user_settings** (настройки пользователя):
  - `user_id` - ID пользователя (связан с users.id)
  - `notifications_enabled` - включены ли уведомления
  - `language` - язык интерфейса
  - `theme` - тема интерфейса
  - `auto_play` - автоматическое воспроизведение
  - `settings` - дополнительные настройки (JSON)
  - `updated_at` - дата обновления

- **Таблица quizlogic** (логика квиза для практик):
  - `id` - уникальный идентификатор
  - `type` - тип практики (meditation, physical, breathing, short_7_min)
  - `duration` - длительность практики (до 20 мин, 20-40 мин, 40-60 мин, etc.)
  - `goal` - цель практики (зависит от типа)
  - `approach` - подход к практике (self-guided, guided) - только для медитации
  - `content_type` - тип контента (video, audio, timer)
  - `content_url` - URL к контенту
  - `title` - название практики
  - `description` - описание практики
  - `created_at` - дата создания
  - `updated_at` - дата обновления

- **Дополнительные таблицы для хранения данных**:
  - `progress` - прогресс пользователя по контенту
  - `favorites` - избранный контент пользователя
  - `view_history` - история просмотров пользователя
  - `ratings` - оценки контента пользователем
  - `notifications` - уведомления для пользователя
  - `schedules` - расписание практик пользователя

## Зависимости и используемые технологии
- **Авторизация**: Supabase Auth
- **Frontend**: Next.js 15.1.0, React 19, TypeScript 5
- **Стилизация**: TailwindCSS
- **БД**: Supabase для хранения данных пользователей и логики квиза
- **UI-компоненты**: Framer Motion для анимаций
- **Мультимедиа**: HTML5 Video/Audio для плеера

## Структура файлов
```
w_ivan
├── docs                        # Документация проекта
│   ├── architecture.md         # Описание архитектуры
│   ├── SHORT_PLANNING.md       # Краткосрочное планирование
│   └── TASK.md                 # Задачи проекта
├── public                      # Статические файлы
│   └── surf                    # Изображения для приложения
├── src                         # Исходный код
│   ├── app                     # App Router структура Next.js
│   │   ├── page.tsx            # Главная страница с кнопкой "Выбрать практику"
│   │   ├── auth/               # Страницы авторизации
│   │   │   ├── login/          # Страница входа
│   │   │   ├── register/       # Страница регистрации
│   │   │   └── reset-password/ # Страница восстановления пароля
│   │   └── profile/            # Страница профиля пользователя
│   ├── components              # React компоненты
│   │   ├── Auth/               # Компоненты авторизации
│   │   │   ├── LoginForm.tsx   # Форма входа
│   │   │   ├── RegisterForm.tsx # Форма регистрации
│   │   │   └── ResetPasswordForm.tsx # Форма восстановления пароля
│   │   ├── Profile/            # Компоненты профиля
│   │   │   ├── ProfileInfo.tsx # Информация о пользователе
│   │   │   └── ProfileSettings.tsx # Настройки пользователя
│   │   ├── Player              # Компоненты плеера
│   │   │   ├── Player.tsx      # Основной компонент плеера
│   │   │   ├── MeditationTimerMode.tsx # Режим медитации с таймером
│   │   │   ├── MeditationAudioMode.tsx # Режим медитации с аудио
│   │   │   └── VideoMode.tsx   # Режим видео
│   │   └── Quiz                # Компоненты квиза
│   │       ├── PracticeSelectionScreen.tsx # Экран выбора практики
│   │       ├── HowItWorksScreen.tsx # Экран "Как это работает"
│   │       ├── ShortPracticeGoalScreen.tsx # Экран выбора цели для "До 7 мин"
│   │       ├── PhysicalTimeScreen.tsx # Экран выбора времени телесной практики
│   │       ├── ShortPhysicalGoalScreen.tsx # Экран выбора цели для короткой телесной практики
│   │       ├── LongPhysicalGoalScreen.tsx # Экран выбора цели для длинной телесной практики
│   │       ├── BreathingGoalScreen.tsx # Экран выбора цели для дыхательной практики
│   │       ├── MeditationApproachScreen.tsx # Экран выбора подхода к медитации
│   │       ├── SelfGuidedTimePicker.tsx # Экран выбора времени для самостоятельной медитации
│   │       ├── ConcentrationObjectScreen.tsx # Экран выбора объекта концентрации
│   │       ├── GuidedMeditationThemeScreen.tsx # Экран выбора темы для медитации
│   │       └── GuidedMeditationGoalScreen.tsx # Экран выбора цели для медитации
│   ├── context                 # React контексты
│   │   ├── AuthContext.tsx     # Контекст для управления авторизацией
│   │   ├── QuizContext.tsx     # Контекст для состояния квиза
│   │   └── PlayerContext.tsx   # Контекст для управления плеером
│   └── lib                     # Вспомогательные функции и утилиты
│       ├── supabase.ts         # Клиент и утилиты для Supabase
│       ├── auth.ts             # Утилиты для работы с авторизацией
│       └── types.ts            # Типы данных
├── middleware.ts               # Middleware для проверки авторизации и защиты маршрутов
├── next.config.ts              # Конфигурация Next.js
├── package.json                # Зависимости и скрипты проекта
├── postcss.config.mjs          # Конфигурация PostCSS
├── tailwind.config.ts          # Конфигурация Tailwind CSS
└── tsconfig.json               # Конфигурация TypeScript
```

## Важные моменты и хаки
- Авторизация реализована через Supabase Auth с JWT токенами
- Профиль пользователя синхронизируется с базой данных Supabase
- Плеер имеет три режима работы: медитация с таймером, медитация с аудио и видео, с общим интерфейсом
- Квиз использует разветвленную структуру с четырьмя ветками и разным количеством шагов
- Логика рекомендаций практик реализована через фильтрацию данных из Supabase
- Прогресс пользователя и история просмотров сохраняются в соответствующих таблицах
- Кнопка "Назад" на всех экранах для последовательного возврата по шагам
- Анимированные переходы между экранами для улучшения UX

## Последняя верификация: 13.05.2024