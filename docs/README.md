# Документация по Yoga Bot (Telegram Mini App)

## Обзор проекта

Yoga Bot - это Telegram Mini App, разработанное для помощи пользователям с йога-практикой. Приложение использует интеграцию с Telegram API через SDK @telegram-apps/sdk и Supabase для хранения данных пользователей.

## Основные компоненты

1. **Интеграция с Telegram SDK**
   - `TelegramViewportStyle.tsx` - инициализация SDK и настройка CSS переменных
   - `TelegramContext.tsx` - контекст для доступа к данным пользователя и WebApp

2. **Хранение данных**
   - Supabase - используется для хранения данных пользователей и логов
   - Поля `photo_url` и `telegram_auth_date` требуют специальной обработки

3. **Отладочные инструменты**
   - `DebugPanel.tsx` - оптимизированная панель для отображения логов и данных пользователя
   - `create-test-user.js` - CLI скрипт для создания тестового пользователя

## Важные заметки по разработке

### Интеграция с Telegram SDK

Для правильной работы с Telegram SDK необходимо:

1. Инициализировать SDK через `init()` в корневом компоненте
2. Использовать `retrieveLaunchParams()` для получения данных пользователя
3. Обрабатывать ошибки и иметь запасной вариант через `window.Telegram.WebApp.initDataUnsafe`
4. Проперти типизировать через интерфейс `TelegramUser`

### Работа с временными метками

Telegram передает временные метки в формате Unix timestamp (секунды с 1970 года), а Supabase требует ISO-формат для поля `telegram_auth_date`. Необходимо преобразовывать формат:

```typescript
// Преобразование Unix timestamp в ISO формат
const convertAuthDateToISO = (authDate: number) => {
  return new Date(authDate * 1000).toISOString();
};
```

### Оптимизация производительности

Для уменьшения лагов при работе с Supabase:

1. Ограничьте частоту запросов (rate limiting)
2. Используйте кэширование данных где возможно
3. Используйте `useMemo` и `useCallback` для оптимизации React компонентов
4. Ограничивайте количество возвращаемых записей в запросах
5. Используйте `maybeSingle()` вместо `single()` для избежания ошибок

## Полезные скрипты

### create-test-user.js

CLI скрипт для создания тестового пользователя в Supabase. Запускается командой:

```bash
node create-test-user.js
```

## Дополнительная документация

- [TELEGRAM_SDK_FIXES.md](./TELEGRAM_SDK_FIXES.md) - подробное описание исправлений SDK
- [TASK.md](./TASK.md) - текущий статус задач и плана работ
- [SHORT_PLANNING.md](./SHORT_PLANNING.md) - краткосрочный план и чеклист качества

## Проблемы и решения

### Общие проблемы

1. **Проблема**: Пользователь не создается в Supabase
   **Решение**: Проверьте формат поля `telegram_auth_date` и убедитесь, что оно сохраняется в ISO формате

2. **Проблема**: Фото пользователя не отображается
   **Решение**: Проверьте, что поле `photo_url` корректно сохраняется и извлекается из SDK

3. **Проблема**: Лаги в отображении данных
   **Решение**: Используйте описанные выше методы оптимизации и ограничьте частоту запросов 