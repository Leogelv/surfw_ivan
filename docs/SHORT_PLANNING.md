# КРАТКОСРОЧНОЕ ПЛАНИРОВАНИЕ

## Текущая задача
- Настроить корректную авторизацию пользователей с записью в таблицу users
- Исправить проблемы с дебаг-панелью (лаги, ошибки в консоли)
- Добавить в дебаг-панель кнопки быстрого копирования
- Исправить отступы content safe area на главной странице
- Настроить корректное отображение Telegram Mini App в fullscreen режиме
- Использовать web_app_request_fullscreen вместо устаревшего метода expand()
- Обеспечить сохранение данных пользователя в таблице users
- Улучшить функцию createUserInSupabase в TelegramContext.tsx
- Обеспечить надежное создание пользователей в Supabase с учетом ограничений внешних ключей
- Привести код к единому паттерну, используемому в тестовых скриптах
- Улучшить обработку ошибок и логирование процесса создания/обновления пользователя
- Исправить интеграцию с Telegram Mini Apps SDK
- Обеспечить корректное получение данных пользователя из Telegram
- Упростить панель отладки с фокусом на логи и initData
- Реализовать функциональность полноэкранного режима

## Чеклисты проверок
- [x] Проверить создание пользователя в таблице users при открытии приложения
- [x] Исправить дебаг-панель (добавить кнопки копирования, устранить ошибки)
- [x] Настроить корректные отступы для контента (safeAreaInsets и contentSafeAreaInsets)
- [x] Проверить интеграцию с Telegram Mini Apps SDK (init, саф-ареа и др.)
- [x] Проверить работу логирования в таблицу logs и вывод логов в дебаг-панель
- [x] Протестировать создание пользователя через CLI (прямой запрос к Supabase)
- [x] Интегрировать логику создания пользователя из CLI-скрипта в код приложения
- [x] Реализовать переключение в fullscreen режим через web_app_request_fullscreen
- [x] Обеспечить корректное сохранение данных пользователя в таблице users независимо от RLS
- [x] Создание пользователя в auth.users перед созданием в public.users
- [x] Проверка работы триггеров для автоматического создания записей
- [x] Корректная обработка поля auth_date и других преобразований данных
- [x] Создание/обновление настроек пользователя в таблице user_settings
- [x] Удаление устаревшего кода обхода ограничений внешних ключей
- [x] Проверка работы с новыми и существующими пользователями
- [x] Корректная инициализация SDK Telegram Mini Apps через init()
- [x] Использование retrieveLaunchParams для получения данных пользователя
- [x] Надежное создание пользователя в Supabase (в auth.users и public.users)
- [x] Функциональность postEvent('web_app_request_fullscreen') для полноэкранного режима
- [x] Упрощенная панель отладки с табами для логов и initData
- [x] Проверка обработки различных ошибок SDK и Telegram WebApp
- [x] Кнопки копирования данных в буфер обмена в панели отладки

## Навигация по проекту
- Авторизация: интеграция Telegram auth с Supabase
- Отладка: компонент DebugPanel для просмотра состояния приложения
- Telegram интеграция: TelegramContext для взаимодействия с Telegram WebApp
- Supabase: таблицы users, logs для хранения данных пользователей и логирования

## Консистентность флоу
- Инициализация Telegram WebApp при загрузке страницы
- Получение данных пользователя из Telegram
- Создание/обновление пользователя в таблице users
- Логирование событий в консоль и в таблицу logs
- Отображение информации в дебаг-панели

## Что сделано
- Создана утилита логирования с записью в Supabase
- Реализован TelegramContext для работы с Telegram WebApp
- Настроен AuthContext для управления авторизацией
- Создан компонент дебаг-панели для отладки
- Настроены отступы для корректного отображения в Telegram Mini App
- Добавлена вкладка Viewport и Safe Area в дебаг-панели
- Добавлены кнопки копирования во все блоки дебаг-панели
- Улучшена интеграция с Telegram SDK, корректно обрабатываются safeAreaInsets
- Исправлена интеграция Telegram и Supabase для корректного создания пользователей
- Добавлены CSS-переменные для работы с отступами в Telegram Mini App
- Создан скрипт для тестового создания пользователя через CLI (create-test-user.js)
- Успешно протестировано создание пользователя через прямой SQL-запрос к Supabase
- Интегрирована логика создания пользователя из CLI-скрипта в код приложения
- Исправлена обработка поля auth_date для корректного сохранения в числовом формате
- Добавлена поддержка создания настроек пользователя при первой регистрации
- Добавлено использование UUID для генерации ID новых пользователей
- Реализован запрос на полноэкранный режим через web_app_request_fullscreen с fallback на expand()
- Реализована надежная система создания/обновления пользователя в таблице users в Supabase
- Улучшена обработка ошибок при сохранении данных в Supabase
- Добавлена возможность отображения пользовательских данных в дебаг-панели через пропсы
- Улучшена функция createUserInSupabase для надежного создания пользователей
- Добавлена проверка работы триггеров и ручное создание записей при необходимости
- Улучшена обработка ошибок и логирование процесса создания пользователя
- Исправлена обработка поля auth_date и другие преобразования данных
- Удален устаревший код создания пользователя в обход auth.users
- Отладочная панель теперь не содержит лишней информации и фокусируется на необходимых данных
- При возникновении ошибок SDK есть запасные механизмы получения данных пользователя через WebApp
- Выполнен рефакторинг page.tsx, компонент разбит на более мелкие модули (MainContent, AppNavigation, и др.)
- Создана утилита cssUtils.ts для безопасной работы с CSS-переменными с учетом SSR
- Созданы компоненты TelegramThemeManager и TelegramSafeAreaHandler для управления Telegram-специфичными функциями
- Создан компонент LoggingProvider для улучшения логирования
- Исправлена ошибка "window is not defined" в контексте SSR с помощью проверок typeof window !== 'undefined'
- Исправлена ошибка "document is not defined" с помощью проверок typeof document !== 'undefined'
- Добавлены useCallback для оптимизации перерендеров и улучшения производительности

## Последнее обновление
- Дата: 13.11.2024
- Время: 22:30 

# Краткосрочный план разработки

## Приоритетные задачи

### 1. Исправление ошибки создания пользователя в Supabase
- **Причина**: Ограничение внешнего ключа `users_id_fkey` требует, чтобы ID пользователя сначала был создан в `auth.users`
- **Решение**: Модифицировать процесс создания/обновления пользователя
  - Сначала использовать Auth API для создания записи в `auth.users`
  - Затем создать/обновить запись в `public.users` с тем же ID
  - Обновить скрипт тестирования для проверки корректной работы

### 2. Улучшение функциональности Telegram Mini App
- **Задача**: Добавить поддержку методов для улучшения UX
  - Реализовать корректную обработку `web_app_setup_closing_behavior`
  - Настроить `web_app_setup_swipe_behavior` для отключения вертикальных свайпов
  - Внедрить `web_app_request_content_safe_area` для корректных отступов на всех страницах

### 3. Документация и тестирование
- Обновить документацию по методам Telegram Mini App
- Создать тестовые сценарии для проверки новой функциональности
- Задокументировать структуру таблиц в Supabase и зависимости между ними

## Чеклист проверок

- [x] Пользователь корректно создается в Supabase с данными из Telegram
- [x] Настройки пользователя сохраняются в таблице `user_settings`
- [x] Приложение корректно обрабатывает отступы (content safe area)
- [x] Отключены вертикальные свайпы для закрытия приложения
- [x] Подтверждение закрытия приложения работает корректно
- [x] Документация актуализирована

## Навигация по файлам

| Файл | Описание | Статус |
|------|----------|--------|
| src/components/TelegramViewportStyle.tsx | Инициализация SDK и запрос fullscreen | ✅ |
| src/context/TelegramContext.tsx | Логика работы с данными пользователя | ✅ |
| src/hooks/useSupabase.ts | Хук для работы с Supabase | ✅ |
| src/components/Debug/DebugPanel.tsx | Панель отладки с поддержкой пропсов | ✅ |
| src/components/Debug/DebugPanel.module.css | Стили для панели отладки | ✅ |
| create-test-user.js | CLI-скрипт для создания тестового пользователя | ✅ |
| docs/TELEGRAM_SDK_FIXES.md | Документация по исправлениям | ✅ |

# Краткий план по интеграции с Telegram Mini Apps SDK

## Текущие правки (май 2024)

1. ✅ Настройка получения данных через SDK аналогично DebugPanel
2. ✅ Исправление методов работы с полноэкранным режимом (web_app_request_fullscreen)
3. ✅ Добавление обработки событий content_safe_area_changed
4. ✅ Настройка вертикальных свайпов (web_app_setup_swipe_behavior)
allow_vertical_swipe5. ✅ Добавление поддержки темы оформления Telegram (web_app_request_theme)

## Чек-лист для проверки

- [ ] Данные из Telegram корректно отображаются в дебаг-панели
- [ ] Полноэкранный режим работает на мобильных устройствах
- [ ] Корректно отображаются отступы с учетом безопасной зоны контента
- [ ] Вертикальные свайпы работают для закрытия приложения
- [ ] Приложение адаптируется к теме Telegram (светлая/темная)

## Архитектура взаимодействия с Telegram SDK

```
┌─────────────────────┐      ┌───────────────────┐
│ TelegramContext.tsx │◄────►│ Telegram SDK      │
└─────────┬───────────┘      └───────────────────┘
          │
          ▼
┌─────────────────────┐      ┌───────────────────┐
│ page.tsx (YogaApp)  │◄────►│ DebugPanel.tsx    │
└─────────────────────┘      └───────────────────┘
```

## Используемые методы из методов_тг_full.md

- web_app_request_fullscreen
- web_app_request_content_safe_area
- web_app_setup_swipe_behavior
- web_app_ready
- web_app_request_theme

## Примечания для тестирования

- Проверить на iOS и Android устройствах
- Проверить на iPhone с челкой для корректности отступов
- Проверить работу на разных версиях Telegram (>=6.1)
- Проверить работу вертикальных свайпов с параметром `allow_vertical_swipe: true`
- Проверить переключение между светлой и темной темами Telegram

## CSS переменные для интеграции с Telegram

### Отступы безопасной зоны
```css
:root {
  --safe-area-top: 30px;
  --safe-area-right: 0px;
  --safe-area-bottom: 0px;
  --safe-area-left: 0px;
  
  /* Альтернативный формат */
  --tg-content-safe-area-top: 30px;
  --tg-content-safe-area-right: 0px;
  --tg-content-safe-area-bottom: 0px;
  --tg-content-safe-area-left: 0px;
}
```

### Параметры темы
```css
:root {
  /* Прямые переменные из Telegram */
  --tg-theme-bg-color: #ffffff;
  --tg-theme-text-color: #000000;
  --tg-theme-hint-color: #999999;
  --tg-theme-link-color: #2481cc;
  --tg-theme-button-color: #2481cc;
  --tg-theme-button-text-color: #ffffff;
  
  /* Упрощенные алиасы */
  --tg-theme-bg: #ffffff;
  --tg-theme-text: #000000;
  --tg-theme-hint: #999999;
  --tg-theme-link: #2481cc;
  --tg-theme-button: #2481cc;
  --tg-theme-button-text: #ffffff;
}
```

# Краткосрочный план: Документирование проекта

**Задача:** Создать детальный `architecture.md`.

**Чеклист:**
- [ ] Создать `docs/TASK.md`.
- [ ] Проанализировать структуру проекта.
- [ ] Описать схему БД (таблицы, поля, связи).
- [ ] Описать логику авторизации (Telegram -> Supabase).
- [ ] Описать маршрутизацию (Next.js App Router).
- [ ] Описать управление состоянием (Context API, Hooks).
- [ ] Описать интеграцию с Telegram Mini App SDK.
- [ ] Описать ключевые компоненты и их назначение.
- [ ] Описать использование переменных окружения.
- [ ] Описать процесс деплоя (Vercel).
- [ ] Описать важные скрипты и файлы.
- [ ] Описать общий поток данных для отображения на главной странице.
- [ ] Добавить структуру файлов в `architecture.md`.
- [ ] Поставить метку последней верификации. 

# КРАТКОСРОЧНЫЙ ПЛАН

## Текущая задача: Рефакторинг page.tsx и устранение ошибок

### Шаги:
1. Исправление ошибки с window is not defined в продакшене
   - Проблема связана с попыткой доступа к window в SSR
   - Необходимо обернуть все обращения к window в проверку typeof window !== 'undefined'

2. Разбиение page.tsx на компоненты:
   - MainContent: основное содержимое приложения
   - AppNavigation: навигационное меню
   - FloatingDebugButton: кнопка вызова отладочной панели
   - TelegramThemeManager: управление темой и CSS-переменными
   - TelegramSafeAreaHandler: обработка событий изменения безопасной зоны
   - LoggingProvider: компонент для расширенного логирования

3. Создание утилит для стилей:
   - cssUtils.ts: безопасное управление CSS-переменными с учетом SSR

### Чеклист выполнения:
- [x] Ошибка "window is not defined" исправлена
- [x] Создан компонент TelegramThemeManager для управления темой
- [x] Создан компонент TelegramSafeAreaHandler для обработки событий
- [x] Создан компонент LoggingProvider для логирования
- [x] Создана утилита cssUtils.ts
- [x] Размер page.tsx уменьшен за счет выделения компонентов
- [x] Все проверки typeof window !== 'undefined' добавлены
- [x] Все проверки typeof document !== 'undefined' добавлены

## Следующие шаги:
1. Тестирование в продакшен среде
2. Дальнейшее разбиение крупных компонентов
3. Улучшение типизации и документирование компонентов

# КРАТКОСРОЧНОЕ ПЛАНИРОВАНИЕ

## Текущая задача
- Настроить корректную авторизацию пользователей с записью в таблицу users
- Исправить проблемы с дебаг-панелью (лаги, ошибки в консоли)
- Добавить в дебаг-панель кнопки быстрого копирования
- Исправить отступы content safe area на главной странице
- Настроить корректное отображение Telegram Mini App в fullscreen режиме
- Использовать web_app_request_fullscreen вместо устаревшего метода expand()
- Обеспечить сохранение данных пользователя в таблице users
- Улучшить функцию createUserInSupabase в TelegramContext.tsx
- Обеспечить надежное создание пользователей в Supabase с учетом ограничений внешних ключей
- Привести код к единому паттерну, используемому в тестовых скриптах
- Улучшить обработку ошибок и логирование процесса создания/обновления пользователя
- Исправить интеграцию с Telegram Mini Apps SDK
- Обеспечить корректное получение данных пользователя из Telegram
- Упростить панель отладки с фокусом на логи и initData
- Реализовать функциональность полноэкранного режима

## Чеклисты проверок
- [x] Проверить создание пользователя в таблице users при открытии приложения
- [x] Исправить дебаг-панель (добавить кнопки копирования, устранить ошибки)
- [x] Настроить корректные отступы для контента (safeAreaInsets и contentSafeAreaInsets)
- [x] Проверить интеграцию с Telegram Mini Apps SDK (init, саф-ареа и др.)
- [x] Проверить работу логирования в таблицу logs и вывод логов в дебаг-панель
- [x] Протестировать создание пользователя через CLI (прямой запрос к Supabase)
- [x] Интегрировать логику создания пользователя из CLI-скрипта в код приложения
- [x] Реализовать переключение в fullscreen режим через web_app_request_fullscreen
- [x] Обеспечить корректное сохранение данных пользователя в таблице users независимо от RLS
- [x] Создание пользователя в auth.users перед созданием в public.users
- [x] Проверка работы триггеров для автоматического создания записей
- [x] Корректная обработка поля auth_date и других преобразований данных
- [x] Создание/обновление настроек пользователя в таблице user_settings
- [x] Удаление устаревшего кода обхода ограничений внешних ключей
- [x] Проверка работы с новыми и существующими пользователями
- [x] Корректная инициализация SDK Telegram Mini Apps через init()
- [x] Использование retrieveLaunchParams для получения данных пользователя
- [x] Надежное создание пользователя в Supabase (в auth.users и public.users)
- [x] Функциональность postEvent('web_app_request_fullscreen') для полноэкранного режима
- [x] Упрощенная панель отладки с табами для логов и initData
- [x] Проверка обработки различных ошибок SDK и Telegram WebApp
- [x] Кнопки копирования данных в буфер обмена в панели отладки

## Навигация по проекту
- Авторизация: интеграция Telegram auth с Supabase
- Отладка: компонент DebugPanel для просмотра состояния приложения
- Telegram интеграция: TelegramContext для взаимодействия с Telegram WebApp
- Supabase: таблицы users, logs для хранения данных пользователей и логирования

## Консистентность флоу
- Инициализация Telegram WebApp при загрузке страницы
- Получение данных пользователя из Telegram
- Создание/обновление пользователя в таблице users
- Логирование событий в консоль и в таблицу logs
- Отображение информации в дебаг-панели

## Что сделано
- Создана утилита логирования с записью в Supabase
- Реализован TelegramContext для работы с Telegram WebApp
- Настроен AuthContext для управления авторизацией
- Создан компонент дебаг-панели для отладки
- Настроены отступы для корректного отображения в Telegram Mini App
- Добавлена вкладка Viewport и Safe Area в дебаг-панели
- Добавлены кнопки копирования во все блоки дебаг-панели
- Улучшена интеграция с Telegram SDK, корректно обрабатываются safeAreaInsets
- Исправлена интеграция Telegram и Supabase для корректного создания пользователей
- Добавлены CSS-переменные для работы с отступами в Telegram Mini App
- Создан скрипт для тестового создания пользователя через CLI (create-test-user.js)
- Успешно протестировано создание пользователя через прямой SQL-запрос к Supabase
- Интегрирована логика создания пользователя из CLI-скрипта в код приложения
- Исправлена обработка поля auth_date для корректного сохранения в числовом формате
- Добавлена поддержка создания настроек пользователя при первой регистрации
- Добавлено использование UUID для генерации ID новых пользователей
- Реализован запрос на полноэкранный режим через web_app_request_fullscreen с fallback на expand()
- Реализована надежная система создания/обновления пользователя в таблице users в Supabase
- Улучшена обработка ошибок при сохранении данных в Supabase
- Добавлена возможность отображения пользовательских данных в дебаг-панели через пропсы
- Улучшена функция createUserInSupabase для надежного создания пользователей
- Добавлена проверка работы триггеров и ручное создание записей при необходимости
- Улучшена обработка ошибок и логирование процесса создания пользователя
- Исправлена обработка поля auth_date и другие преобразования данных
- Удален устаревший код создания пользователя в обход auth.users
- Отладочная панель теперь не содержит лишней информации и фокусируется на необходимых данных
- При возникновении ошибок SDK есть запасные механизмы получения данных пользователя через WebApp

## Последнее обновление
- Дата: 13.11.2024
- Время: 22:30 

# Краткосрочный план разработки

## Приоритетные задачи

### 1. Исправление ошибки создания пользователя в Supabase
- **Причина**: Ограничение внешнего ключа `users_id_fkey` требует, чтобы ID пользователя сначала был создан в `auth.users`
- **Решение**: Модифицировать процесс создания/обновления пользователя
  - Сначала использовать Auth API для создания записи в `auth.users`
  - Затем создать/обновить запись в `public.users` с тем же ID
  - Обновить скрипт тестирования для проверки корректной работы

### 2. Улучшение функциональности Telegram Mini App
- **Задача**: Добавить поддержку методов для улучшения UX
  - Реализовать корректную обработку `web_app_setup_closing_behavior`
  - Настроить `web_app_setup_swipe_behavior` для отключения вертикальных свайпов
  - Внедрить `web_app_request_content_safe_area` для корректных отступов на всех страницах

### 3. Документация и тестирование
- Обновить документацию по методам Telegram Mini App
- Создать тестовые сценарии для проверки новой функциональности
- Задокументировать структуру таблиц в Supabase и зависимости между ними

## Чеклист проверок

- [x] Пользователь корректно создается в Supabase с данными из Telegram
- [x] Настройки пользователя сохраняются в таблице `user_settings`
- [x] Приложение корректно обрабатывает отступы (content safe area)
- [x] Отключены вертикальные свайпы для закрытия приложения
- [x] Подтверждение закрытия приложения работает корректно
- [x] Документация актуализирована

## Навигация по файлам

| Файл | Описание | Статус |
|------|----------|--------|
| src/components/TelegramViewportStyle.tsx | Инициализация SDK и запрос fullscreen | ✅ |
| src/context/TelegramContext.tsx | Логика работы с данными пользователя | ✅ |
| src/hooks/useSupabase.ts | Хук для работы с Supabase | ✅ |
| src/components/Debug/DebugPanel.tsx | Панель отладки с поддержкой пропсов | ✅ |
| src/components/Debug/DebugPanel.module.css | Стили для панели отладки | ✅ |
| create-test-user.js | CLI-скрипт для создания тестового пользователя | ✅ |
| docs/TELEGRAM_SDK_FIXES.md | Документация по исправлениям | ✅ |

# Краткий план по интеграции с Telegram Mini Apps SDK

## Текущие правки (май 2024)

1. ✅ Настройка получения данных через SDK аналогично DebugPanel
2. ✅ Исправление методов работы с полноэкранным режимом (web_app_request_fullscreen)
3. ✅ Добавление обработки событий content_safe_area_changed
4. ✅ Настройка вертикальных свайпов (web_app_setup_swipe_behavior)
allow_vertical_swipe5. ✅ Добавление поддержки темы оформления Telegram (web_app_request_theme)

## Чек-лист для проверки

- [ ] Данные из Telegram корректно отображаются в дебаг-панели
- [ ] Полноэкранный режим работает на мобильных устройствах
- [ ] Корректно отображаются отступы с учетом безопасной зоны контента
- [ ] Вертикальные свайпы работают для закрытия приложения
- [ ] Приложение адаптируется к теме Telegram (светлая/темная)

## Архитектура взаимодействия с Telegram SDK

```
┌─────────────────────┐      ┌───────────────────┐
│ TelegramContext.tsx │◄────►│ Telegram SDK      │
└─────────┬───────────┘      └───────────────────┘
          │
          ▼
┌─────────────────────┐      ┌───────────────────┐
│ page.tsx (YogaApp)  │◄────►│ DebugPanel.tsx    │
└─────────────────────┘      └───────────────────┘
```

## Используемые методы из методов_тг_full.md

- web_app_request_fullscreen
- web_app_request_content_safe_area
- web_app_setup_swipe_behavior
- web_app_ready
- web_app_request_theme

## Примечания для тестирования

- Проверить на iOS и Android устройствах
- Проверить на iPhone с челкой для корректности отступов
- Проверить работу на разных версиях Telegram (>=6.1)
- Проверить работу вертикальных свайпов с параметром `allow_vertical_swipe: true`
- Проверить переключение между светлой и темной темами Telegram

## CSS переменные для интеграции с Telegram

### Отступы безопасной зоны
```css
:root {
  --safe-area-top: 30px;
  --safe-area-right: 0px;
  --safe-area-bottom: 0px;
  --safe-area-left: 0px;
  
  /* Альтернативный формат */
  --tg-content-safe-area-top: 30px;
  --tg-content-safe-area-right: 0px;
  --tg-content-safe-area-bottom: 0px;
  --tg-content-safe-area-left: 0px;
}
```

### Параметры темы
```css
:root {
  /* Прямые переменные из Telegram */
  --tg-theme-bg-color: #ffffff;
  --tg-theme-text-color: #000000;
  --tg-theme-hint-color: #999999;
  --tg-theme-link-color: #2481cc;
  --tg-theme-button-color: #2481cc;
  --tg-theme-button-text-color: #ffffff;
  
  /* Упрощенные алиасы */
  --tg-theme-bg: #ffffff;
  --tg-theme-text: #000000;
  --tg-theme-hint: #999999;
  --tg-theme-link: #2481cc;
  --tg-theme-button: #2481cc;
  --tg-theme-button-text: #ffffff;
}
```

# Краткосрочный план: Документирование проекта

**Задача:** Создать детальный `architecture.md`.

**Чеклист:**
- [ ] Создать `docs/TASK.md`.
- [ ] Проанализировать структуру проекта.
- [ ] Описать схему БД (таблицы, поля, связи).
- [ ] Описать логику авторизации (Telegram -> Supabase).
- [ ] Описать маршрутизацию (Next.js App Router).
- [ ] Описать управление состоянием (Context API, Hooks).
- [ ] Описать интеграцию с Telegram Mini App SDK.
- [ ] Описать ключевые компоненты и их назначение.
- [ ] Описать использование переменных окружения.
- [ ] Описать процесс деплоя (Vercel).
- [ ] Описать важные скрипты и файлы.
- [ ] Описать общий поток данных для отображения на главной странице.
- [ ] Добавить структуру файлов в `architecture.md`.
- [ ] Поставить метку последней верификации. 

# КРАТКОСРОЧНЫЙ ПЛАН

## Текущая задача: Рефакторинг page.tsx и устранение ошибок

### Шаги:
1. Исправление ошибки с window is not defined в продакшене
   - Проблема связана с попыткой доступа к window в SSR
   - Необходимо обернуть все обращения к window в проверку typeof window !== 'undefined'

2. Разбиение page.tsx на компоненты:
   - MainContent: основное содержимое приложения
   - AppNavigation: навигационное меню
   - FloatingDebugButton: кнопка вызова отладочной панели
   - TelegramThemeManager: управление темой и CSS-переменными
   - TelegramSafeAreaHandler: обработка событий изменения безопасной зоны
   - LoggingProvider: компонент для расширенного логирования

3. Создание утилит для стилей:
   - cssUtils.ts: безопасное управление CSS-переменными с учетом SSR

### Чеклист выполнения:
- [x] Ошибка "window is not defined" исправлена
- [x] Создан компонент TelegramThemeManager для управления темой
- [x] Создан компонент TelegramSafeAreaHandler для обработки событий
- [x] Создан компонент LoggingProvider для логирования
- [x] Создана утилита cssUtils.ts
- [x] Размер page.tsx уменьшен за счет выделения компонентов
- [x] Все проверки typeof window !== 'undefined' добавлены
- [x] Все проверки typeof document !== 'undefined' добавлены

## Следующие шаги:
1. Тестирование в продакшен среде
2. Дальнейшее разбиение крупных компонентов
3. Улучшение типизации и документирование компонентов

# КРАТКОСРОЧНОЕ ПЛАНИРОВАНИЕ

## Текущая задача
- Настроить корректную авторизацию пользователей с записью в таблицу users
- Исправить проблемы с дебаг-панелью (лаги, ошибки в консоли)
- Добавить в дебаг-панель кнопки быстрого копирования
- Исправить отступы content safe area на главной странице
- Настроить корректное отображение Telegram Mini App в fullscreen режиме
- Использовать web_app_request_fullscreen вместо устаревшего метода expand()
- Обеспечить сохранение данных пользователя в таблице users
- Улучшить функцию createUserInSupabase в TelegramContext.tsx
- Обеспечить надежное создание пользователей в Supabase с учетом ограничений внешних ключей
- Привести код к единому паттерну, используемому в тестовых скриптах
- Улучшить обработку ошибок и логирование процесса создания/обновления пользователя
- Исправить интеграцию с Telegram Mini Apps SDK
- Обеспечить корректное получение данных пользователя из Telegram
- Упростить панель отладки с фокусом на логи и initData
- Реализовать функциональность полноэкранного режима

## Чеклисты проверок
- [x] Проверить создание пользователя в таблице users при открытии приложения
- [x] Исправить дебаг-панель (добавить кнопки копирования, устранить ошибки)
- [x] Настроить корректные отступы для контента (safeAreaInsets и contentSafeAreaInsets)
- [x] Проверить интеграцию с Telegram Mini Apps SDK (init, саф-ареа и др.)
- [x] Проверить работу логирования в таблицу logs и вывод логов в дебаг-панель
- [x] Протестировать создание пользователя через CLI (прямой запрос к Supabase)
- [x] Интегрировать логику создания пользователя из CLI-скрипта в код приложения
- [x] Реализовать переключение в fullscreen режим через web_app_request_fullscreen
- [x] Обеспечить корректное сохранение данных пользователя в таблице users независимо от RLS
- [x] Создание пользователя в auth.users перед созданием в public.users
- [x] Проверка работы триггеров для автоматического создания записей
- [x] Корректная обработка поля auth_date и других преобразований данных
- [x] Создание/обновление настроек пользователя в таблице user_settings
- [x] Удаление устаревшего кода обхода ограничений внешних ключей
- [x] Проверка работы с новыми и существующими пользователями
- [x] Корректная инициализация SDK Telegram Mini Apps через init()
- [x] Использование retrieveLaunchParams для получения данных пользователя
- [x] Надежное создание пользователя в Supabase (в auth.users и public.users)
- [x] Функциональность postEvent('web_app_request_fullscreen') для полноэкранного режима
- [x] Упрощенная панель отладки с табами для логов и initData
- [x] Проверка обработки различных ошибок SDK и Telegram WebApp
- [x] Кнопки копирования данных в буфер обмена в панели отладки

## Навигация по проекту
- Авторизация: интеграция Telegram auth с Supabase
- Отладка: компонент DebugPanel для просмотра состояния приложения
- Telegram интеграция: TelegramContext для взаимодействия с Telegram WebApp
- Supabase: таблицы users, logs для хранения данных пользователей и логирования

## Консистентность флоу
- Инициализация Telegram WebApp при загрузке страницы
- Получение данных пользователя из Telegram
- Создание/обновление пользователя в таблице users
- Логирование событий в консоль и в таблицу logs
- Отображение информации в дебаг-панели

## Что сделано
- Создана утилита логирования с записью в Supabase
- Реализован TelegramContext для работы с Telegram WebApp
- Настроен AuthContext для управления авторизацией
- Создан компонент дебаг-панели для отладки
- Настроены отступы для корректного отображения в Telegram Mini App
- Добавлена вкладка Viewport и Safe Area в дебаг-панели
- Добавлены кнопки копирования во все блоки дебаг-панели
- Улучшена интеграция с Telegram SDK, корректно обрабатываются safeAreaInsets
- Исправлена интеграция Telegram и Supabase для корректного создания пользователей
- Добавлены CSS-переменные для работы с отступами в Telegram Mini App
- Создан скрипт для тестового создания пользователя через CLI (create-test-user.js)
- Успешно протестировано создание пользователя через прямой SQL-запрос к Supabase
- Интегрирована логика создания пользователя из CLI-скрипта в код приложения
- Исправлена обработка поля auth_date для корректного сохранения в числовом формате
- Добавлена поддержка создания настроек пользователя при первой регистрации
- Добавлено использование UUID для генерации ID новых пользователей
- Реализован запрос на полноэкранный режим через web_app_request_fullscreen с fallback на expand()
- Реализована надежная система создания/обновления пользователя в таблице users в Supabase
- Улучшена обработка ошибок при сохранении данных в Supabase
- Добавлена возможность отображения пользовательских данных в дебаг-панели через пропсы
- Улучшена функция createUserInSupabase для надежного создания пользователей
- Добавлена проверка работы триггеров и ручное создание записей при необходимости
- Улучшена обработка ошибок и логирование процесса создания пользователя
- Исправлена обработка поля auth_date и другие преобразования данных
- Удален устаревший код создания пользователя в обход auth.users
- Отладочная панель теперь не содержит лишней информации и фокусируется на необходимых данных
- При возникновении ошибок SDK есть запасные механизмы получения данных пользователя через WebApp

## Последнее обновление
- Дата: 13.11.2024
- Время: 22:30 

# Краткосрочный план разработки

## Приоритетные задачи

### 1. Исправление ошибки создания пользователя в Supabase
- **Причина**: Ограничение внешнего ключа `users_id_fkey` требует, чтобы ID пользователя сначала был создан в `auth.users`
- **Решение**: Модифицировать процесс создания/обновления пользователя
  - Сначала использовать Auth API для создания записи в `auth.users`
  - Затем создать/обновить запись в `public.users` с тем же ID
  - Обновить скрипт тестирования для проверки корректной работы

### 2. Улучшение функциональности Telegram Mini App
- **Задача**: Добавить поддержку методов для улучшения UX
  - Реализовать корректную обработку `web_app_setup_closing_behavior`
  - Настроить `web_app_setup_swipe_behavior` для отключения вертикальных свайпов
  - Внедрить `web_app_request_content_safe_area` для корректных отступов на всех страницах

### 3. Документация и тестирование
- Обновить документацию по методам Telegram Mini App
- Создать тестовые сценарии для проверки новой функциональности
- Задокументировать структуру таблиц в Supabase и зависимости между ними

## Чеклист проверок

- [x] Пользователь корректно создается в Supabase с данными из Telegram
- [x] Настройки пользователя сохраняются в таблице `user_settings`
- [x] Приложение корректно обрабатывает отступы (content safe area)
- [x] Отключены вертикальные свайпы для закрытия приложения
- [x] Подтверждение закрытия приложения работает корректно
- [x] Документация актуализирована

## Навигация по файлам

| Файл | Описание | Статус |
|------|----------|--------|
| src/components/TelegramViewportStyle.tsx | Инициализация SDK и запрос fullscreen | ✅ |
| src/context/TelegramContext.tsx | Логика работы с данными пользователя | ✅ |
| src/hooks/useSupabase.ts | Хук для работы с Supabase | ✅ |
| src/components/Debug/DebugPanel.tsx | Панель отладки с поддержкой пропсов | ✅ |
| src/components/Debug/DebugPanel.module.css | Стили для панели отладки | ✅ |
| create-test-user.js | CLI-скрипт для создания тестового пользователя | ✅ |
| docs/TELEGRAM_SDK_FIXES.md | Документация по исправлениям | ✅ |

# Краткий план по интеграции с Telegram Mini Apps SDK

## Текущие правки (май 2024)

1. ✅ Настройка получения данных через SDK аналогично DebugPanel
2. ✅ Исправление методов работы с полноэкранным режимом (web_app_request_fullscreen)
3. ✅ Добавление обработки событий content_safe_area_changed
4. ✅ Настройка вертикальных свайпов (web_app_setup_swipe_behavior)
allow_vertical_swipe5. ✅ Добавление поддержки темы оформления Telegram (web_app_request_theme)

## Чек-лист для проверки

- [ ] Данные из Telegram корректно отображаются в дебаг-панели
- [ ] Полноэкранный режим работает на мобильных устройствах
- [ ] Корректно отображаются отступы с учетом безопасной зоны контента
- [ ] Вертикальные свайпы работают для закрытия приложения
- [ ] Приложение адаптируется к теме Telegram (светлая/темная)

## Архитектура взаимодействия с Telegram SDK

```
┌─────────────────────┐      ┌───────────────────┐
│ TelegramContext.tsx │◄────►│ Telegram SDK      │
└─────────┬───────────┘      └───────────────────┘
          │
          ▼
┌─────────────────────┐      ┌───────────────────┐
│ page.tsx (YogaApp)  │◄────►│ DebugPanel.tsx    │
└─────────────────────┘      └───────────────────┘
```

## Используемые методы из методов_тг_full.md

- web_app_request_fullscreen
- web_app_request_content_safe_area
- web_app_setup_swipe_behavior
- web_app_ready
- web_app_request_theme

## Примечания для тестирования

- Проверить на iOS и Android устройствах
- Проверить на iPhone с челкой для корректности отступов
- Проверить работу на разных версиях Telegram (>=6.1)
- Проверить работу вертикальных свайпов с параметром `allow_vertical_swipe: true`
- Проверить переключение между светлой и темной темами Telegram

## CSS переменные для интеграции с Telegram

### Отступы безопасной зоны
```css
:root {
  --safe-area-top: 30px;
  --safe-area-right: 0px;
  --safe-area-bottom: 0px;
  --safe-area-left: 0px;
  
  /* Альтернативный формат */
  --tg-content-safe-area-top: 30px;
  --tg-content-safe-area-right: 0px;
  --tg-content-safe-area-bottom: 0px;
  --tg-content-safe-area-left: 0px;
}
```

### Параметры темы
```css
:root {
  /* Прямые переменные из Telegram */
  --tg-theme-bg-color: #ffffff;
  --tg-theme-text-color: #000000;
  --tg-theme-hint-color: #999999;
  --tg-theme-link-color: #2481cc;
  --tg-theme-button-color: #2481cc;
  --tg-theme-button-text-color: #ffffff;
  
  /* Упрощенные алиасы */
  --tg-theme-bg: #ffffff;
  --tg-theme-text: #000000;
  --tg-theme-hint: #999999;
  --tg-theme-link: #2481cc;
  --tg-theme-button: #2481cc;
  --tg-theme-button-text: #ffffff;
}
```

# Краткосрочный план: Документирование проекта

**Задача:** Создать детальный `architecture.md`.

**Чеклист:**
- [ ] Создать `docs/TASK.md`.
- [ ] Проанализировать структуру проекта.
- [ ] Описать схему БД (таблицы, поля, связи).
- [ ] Описать логику авторизации (Telegram -> Supabase).
- [ ] Описать маршрутизацию (Next.js App Router).
- [ ] Описать управление состоянием (Context API, Hooks).
- [ ] Описать интеграцию с Telegram Mini App SDK.
- [ ] Описать ключевые компоненты и их назначение.
- [ ] Описать использование переменных окружения.
- [ ] Описать процесс деплоя (Vercel).
- [ ] Описать важные скрипты и файлы.
- [ ] Описать общий поток данных для отображения на главной странице.
- [ ] Добавить структуру файлов в `architecture.md`.
- [ ] Поставить метку последней верификации. 

# КРАТКОСРОЧНЫЙ ПЛАН

## Текущая задача: Рефакторинг page.tsx и устранение ошибок

### Шаги:
1. Исправление ошибки с window is not defined в продакшене
   - Проблема связана с попыткой доступа к window в SSR
   - Необходимо обернуть все обращения к window в проверку typeof window !== 'undefined'

2. Разбиение page.tsx на компоненты:
   - MainContent: основное содержимое приложения
   - AppNavigation: навигационное меню
   - FloatingDebugButton: кнопка вызова отладочной панели
   - TelegramThemeManager: управление темой и CSS-переменными
   - TelegramSafeAreaHandler: обработка событий изменения безопасной зоны
   - LoggingProvider: компонент для расширенного логирования

3. Создание утилит для стилей:
   - cssUtils.ts: безопасное управление CSS-переменными с учетом SSR

### Чеклист выполнения:
- [x] Ошибка "window is not defined" исправлена
- [x] Создан компонент TelegramThemeManager для управления темой
- [x] Создан компонент TelegramSafeAreaHandler для обработки событий
- [x] Создан компонент LoggingProvider для логирования
- [x] Создана утилита cssUtils.ts
- [x] Размер page.tsx уменьшен за счет выделения компонентов
- [x] Все проверки typeof window !== 'undefined' добавлены
- [x] Все проверки typeof document !== 'undefined' добавлены

## Следующие шаги:
1. Тестирование в продакшен среде
2. Дальнейшее разбиение крупных компонентов
3. Улучшение типизации и документирование компонентов

# КРАТКОСРОЧНОЕ ПЛАНИРОВАНИЕ

## Текущая задача
- Настроить корректную авторизацию пользователей с записью в таблицу users
- Исправить проблемы с дебаг-панелью (лаги, ошибки в консоли)
- Добавить в дебаг-панель кнопки быстрого копирования
- Исправить отступы content safe area на главной странице
- Настроить корректное отображение Telegram Mini App в fullscreen режиме
- Использовать web_app_request_fullscreen вместо устаревшего метода expand()
- Обеспечить сохранение данных пользователя в таблице users
- Улучшить функцию createUserInSupabase в TelegramContext.tsx
- Обеспечить надежное создание пользователей в Supabase с учетом ограничений внешних ключей
- Привести код к единому паттерну, используемому в тестовых скриптах
- Улучшить обработку ошибок и логирование процесса создания/обновления пользователя
- Исправить интеграцию с Telegram Mini Apps SDK
- Обеспечить корректное получение данных пользователя из Telegram
- Упростить панель отладки с фокусом на логи и initData
- Реализовать функциональность полноэкранного режима

## Чеклисты проверок
- [x] Проверить создание пользователя в таблице users при открытии приложения
- [x] Исправить дебаг-панель (добавить кнопки копирования, устранить ошибки)
- [x] Настроить корректные отступы для контента (safeAreaInsets и contentSafeAreaInsets)
- [x] Проверить интеграцию с Telegram Mini Apps SDK (init, саф-ареа и др.)
- [x] Проверить работу логирования в таблицу logs и вывод логов в дебаг-панель
- [x] Протестировать создание пользователя через CLI (прямой запрос к Supabase)
- [x] Интегрировать логику создания пользователя из CLI-скрипта в код приложения
- [x] Реализовать переключение в fullscreen режим через web_app_request_fullscreen
- [x] Обеспечить корректное сохранение данных пользователя в таблице users независимо от RLS
- [x] Создание пользователя в auth.users перед созданием в public.users
- [x] Проверка работы триггеров для автоматического создания записей
- [x] Корректная обработка поля auth_date и других преобразований данных
- [x] Создание/обновление настроек пользователя в таблице user_settings
- [x] Удаление устаревшего кода обхода ограничений внешних ключей
- [x] Проверка работы с новыми и существующими пользователями
- [x] Корректная инициализация SDK Telegram Mini Apps через init()
- [x] Использование retrieveLaunchParams для получения данных пользователя
- [x] Надежное создание пользователя в Supabase (в auth.users и public.users)
- [x] Функциональность postEvent('web_app_request_fullscreen') для полноэкранного режима
- [x] Упрощенная панель отладки с табами для логов и initData
- [x] Проверка обработки различных ошибок SDK и Telegram WebApp
- [x] Кнопки копирования данных в буфер обмена в панели отладки

## Навигация по проекту
- Авторизация: интеграция Telegram auth с Supabase
- Отладка: компонент DebugPanel для просмотра состояния приложения
- Telegram интеграция: TelegramContext для взаимодействия с Telegram WebApp
- Supabase: таблицы users, logs для хранения данных пользователей и логирования

## Консистентность флоу
- Инициализация Telegram WebApp при загрузке страницы
- Получение данных пользователя из Telegram
- Создание/обновление пользователя в таблице users
- Логирование событий в консоль и в таблицу logs
- Отображение информации в дебаг-панели

## Что сделано
- Создана утилита логирования с записью в Supabase
- Реализован TelegramContext для работы с Telegram WebApp
- Настроен AuthContext для управления авторизацией
- Создан компонент дебаг-панели для отладки
- Настроены отступы для корректного отображения в Telegram Mini App
- Добавлена вкладка Viewport и Safe Area в дебаг-панели
- Добавлены кнопки копирования во все блоки дебаг-панели
- Улучшена интеграция с Telegram SDK, корректно обрабатываются safeAreaInsets
- Исправлена интеграция Telegram и Supabase для корректного создания пользователей
- Добавлены CSS-переменные для работы с отступами в Telegram Mini App
- Создан скрипт для тестового создания пользователя через CLI (create-test-user.js)
- Успешно протестировано создание пользователя через прямой SQL-запрос к Supabase
- Интегрирована логика создания пользователя из CLI-скрипта в код приложения
- Исправлена обработка поля auth_date для корректного сохранения в числовом формате
- Добавлена поддержка создания настроек пользователя при первой регистрации
- Добавлено использование UUID для генерации ID новых пользователей
- Реализован запрос на полноэкранный режим через web_app_request_fullscreen с fallback на expand()
- Реализована надежная система создания/обновления пользователя в таблице users в Supabase
- Улучшена обработка ошибок при сохранении данных в Supabase
- Добавлена возможность отображения пользовательских данных в дебаг-панели через пропсы
- Улучшена функция createUserInSupabase для надежного создания пользователей
- Добавлена проверка работы триггеров и ручное создание записей при необходимости
- Улучшена обработка ошибок и логирование процесса создания пользователя
- Исправлена обработка поля auth_date и другие преобразования данных
- Удален устаревший код создания пользователя в обход auth.users
- Отладочная панель теперь не содержит лишней информации и фокусируется на необходимых данных
- При возникновении ошибок SDK есть запасные механизмы получения данных пользователя через WebApp

## Последнее обновление
- Дата: 13.11.2024
- Время: 22:30 

# Краткосрочный план разработки

## Приоритетные задачи

### 1. Исправление ошибки создания пользователя в Supabase
- **Причина**: Ограничение внешнего ключа `users_id_fkey` требует, чтобы ID пользователя сначала был создан в `auth.users`
- **Решение**: Модифицировать процесс создания/обновления пользователя
  - Сначала использовать Auth API для создания записи в `auth.users`
  - Затем создать/обновить запись в `public.users` с тем же ID
  - Обновить скрипт тестирования для проверки корректной работы

### 2. Улучшение функциональности Telegram Mini App
- **Задача**: Добавить поддержку методов для улучшения UX
  - Реализовать корректную обработку `web_app_setup_closing_behavior`
  - Настроить `web_app_setup_swipe_behavior` для отключения вертикальных свайпов
  - Внедрить `web_app_request_content_safe_area` для корректных отступов на всех страницах

### 3. Документация и тестирование
- Обновить документацию по методам Telegram Mini App
- Создать тестовые сценарии для проверки новой функциональности
- Задокументировать структуру таблиц в Supabase и зависимости между ними

## Чеклист проверок

- [x] Пользователь корректно создается в Supabase с данными из Telegram
- [x] Настройки пользователя сохраняются в таблице `user_settings`
- [x] Приложение корректно обрабатывает отступы (content safe area)
- [x] Отключены вертикальные свайпы для закрытия приложения
- [x] Подтверждение закрытия приложения работает корректно
- [x] Документация актуализирована

## Навигация по файлам

| Файл | Описание | Статус |
|------|----------|--------|
| src/components/TelegramViewportStyle.tsx | Инициализация SDK и запрос fullscreen | ✅ |
| src/context/TelegramContext.tsx | Логика работы с данными пользователя | ✅ |
| src/hooks/useSupabase.ts | Хук для работы с Supabase | ✅ |
| src/components/Debug/DebugPanel.tsx | Панель отладки с поддержкой пропсов | ✅ |
| src/components/Debug/DebugPanel.module.css | Стили для панели отладки | ✅ |
| create-test-user.js | CLI-скрипт для создания тестового пользователя | ✅ |
| docs/TELEGRAM_SDK_FIXES.md | Документация по исправлениям | ✅ |

# Краткий план по интеграции с Telegram Mini Apps SDK

## Текущие правки (май 2024)

1. ✅ Настройка получения данных через SDK аналогично DebugPanel
2. ✅ Исправление методов работы с полноэкранным режимом (web_app_request_fullscreen)
3. ✅ Добавление обработки событий content_safe_area_changed
4. ✅ Настройка вертикальных свайпов (web_app_setup_swipe_behavior)
allow_vertical_swipe5. ✅ Добавление поддержки темы оформления Telegram (web_app_request_theme)

## Чек-лист для проверки

- [ ] Данные из Telegram корректно отображаются в дебаг-панели
- [ ] Полноэкранный режим работает на мобильных устройствах
- [ ] Корректно отображаются отступы с учетом безопасной зоны контента
- [ ] Вертикальные свайпы работают для закрытия приложения
- [ ] Приложение адаптируется к теме Telegram (светлая/темная)

## Архитектура взаимодействия с Telegram SDK

```
┌─────────────────────┐      ┌───────────────────┐
│ TelegramContext.tsx │◄────►│ Telegram SDK      │
└─────────┬───────────┘      └───────────────────┘
          │
          ▼
┌─────────────────────┐      ┌───────────────────┐
│ page.tsx (YogaApp)  │◄────►│ DebugPanel.tsx    │
└─────────────────────┘      └───────────────────┘
```

## Используемые методы из методов_тг_full.md

- web_app_request_fullscreen
- web_app_request_content_safe_area
- web_app_setup_swipe_behavior
- web_app_ready
- web_app_request_theme

## Примечания для тестирования

- Проверить на iOS и Android устройствах
- Проверить на iPhone с челкой для корректности отступов
- Проверить работу на разных версиях Telegram (>=6.1)
- Проверить работу вертикальных свайпов с параметром `allow_vertical_swipe: true`
- Проверить переключение между светлой и темной темами Telegram

## CSS переменные для интеграции с Telegram

### Отступы безопасной зоны
```css
:root {
  --safe-area-top: 30px;
  --safe-area-right: 0px;
  --safe-area-bottom: 0px;
  --safe-area-left: 0px;
  
  /* Альтернативный формат */
  --tg-content-safe-area-top: 30px;
  --tg-content-safe-area-right: 0px;
  --tg-content-safe-area-bottom: 0px;
  --tg-content-safe-area-left: 0px;
}
```

### Параметры темы
```css
:root {
  /* Прямые переменные из Telegram */
  --tg-theme-bg-color: #ffffff;
  --tg-theme-text-color: #000000;
  --tg-theme-hint-color: #999999;
  --tg-theme-link-color: #2481cc;
  --tg-theme-button-color: #2481cc;
  --tg-theme-button-text-color: #ffffff;
  
  /* Упрощенные алиасы */
  --tg-theme-bg: #ffffff;
  --tg-theme-text: #000000;
  --tg-theme-hint: #999999;
  --tg-theme-link: #2481cc;
  --tg-theme-button: #2481cc;
  --tg-theme-button-text: #ffffff;
}
```

# Краткосрочный план: Документирование проекта

**Задача:** Создать детальный `architecture.md`.

**Чеклист:**
- [ ] Создать `docs/TASK.md`.
- [ ] Проанализировать структуру проекта.
- [ ] Описать схему БД (таблицы, поля, связи).
- [ ] Описать логику авторизации (Telegram -> Supabase).
- [ ] Описать маршрутизацию (Next.js App Router).
- [ ] Описать управление состоянием (Context API, Hooks).
- [ ] Описать интеграцию с Telegram Mini App SDK.
- [ ] Описать ключевые компоненты и их назначение.
- [ ] Описать использование переменных окружения.
- [ ] Описать процесс деплоя (Vercel).
- [ ] Описать важные скрипты и файлы.
- [ ] Описать общий поток данных для отображения на главной странице.
- [ ] Добавить структуру файлов в `architecture.md`.
- [ ] Поставить метку последней верификации. 

# КРАТКОСРОЧНЫЙ ПЛАН

## Текущая задача: Рефакторинг page.tsx и устранение ошибок

### Шаги:
1. Исправление ошибки с window is not defined в продакшене
   - Проблема связана с попыткой доступа к window в SSR
   - Необходимо обернуть все обращения к window в проверку typeof window !== 'undefined'

2. Разбиение page.tsx на компоненты:
   - MainContent: основное содержимое приложения
   - AppNavigation: навигационное меню
   - FloatingDebugButton: кнопка вызова отладочной панели
   - TelegramThemeManager: управление темой и CSS-переменными
   - TelegramSafeAreaHandler: обработка событий изменения безопасной зоны
   - LoggingProvider: компонент для расширенного логирования

3. Создание утилит для стилей:
   - cssUtils.ts: безопасное управление CSS-переменными с учетом SSR

### Чеклист выполнения:
- [x] Ошибка "window is not defined" исправлена
- [x] Создан компонент TelegramThemeManager для управления темой
- [x] Создан компонент TelegramSafeAreaHandler для обработки событий
- [x] Создан компонент LoggingProvider для логирования
- [x] Создана утилита cssUtils.ts
- [x] Размер page.tsx уменьшен за счет выделения компонентов
- [x] Все проверки typeof window !== 'undefined' добавлены
- [x] Все проверки typeof document !== 'undefined' добавлены

## Следующие шаги:
1. Тестирование в продакшен среде
2. Дальнейшее разбиение крупных компонентов
3. Улучшение типизации и документирование компонентов

# КРАТКОСРОЧНОЕ ПЛАНИРОВАНИЕ

## Текущая задача
- Настроить корректную авторизацию пользователей с записью в таблицу users
- Исправить проблемы с дебаг-панелью (лаги, ошибки в консоли)
- Добавить в дебаг-панель кнопки быстрого копирования
- Исправить отступы content safe area на главной странице
- Настроить корректное отображение Telegram Mini App в fullscreen режиме
- Использовать web_app_request_fullscreen вместо устаревшего метода expand()
- Обеспечить сохранение данных пользователя в таблице users
- Улучшить функцию createUserInSupabase в TelegramContext.tsx
- Обеспечить надежное создание пользователей в Supabase с учетом ограничений внешних ключей
- Привести код к единому паттерну, используемому в тестовых скриптах
- Улучшить обработку ошибок и логирование процесса создания/обновления пользователя
- Исправить интеграцию с Telegram Mini Apps SDK
- Обеспечить корректное получение данных пользователя из Telegram
- Упростить панель отладки с фокусом на логи и initData
- Реализовать функциональность полноэкранного режима

## Чеклисты проверок
- [x] Проверить создание пользователя в таблице users при открытии приложения
- [x] Исправить дебаг-панель (добавить кнопки копирования, устранить ошибки)
- [x] Настроить корректные отступы для контента (safeAreaInsets и contentSafeAreaInsets)
- [x] Проверить интеграцию с Telegram Mini Apps SDK (init, саф-ареа и др.)
- [x] Проверить работу логирования в таблицу logs и вывод логов в дебаг-панель
- [x] Протестировать создание пользователя через CLI (прямой запрос к Supabase)
- [x] Интегрировать логику создания пользователя из CLI-скрипта в код приложения
- [x] Реализовать переключение в fullscreen режим через web_app_request_fullscreen
- [x] Обеспечить корректное сохранение данных пользователя в таблице users независимо от RLS
- [x] Создание пользователя в auth.users перед созданием в public.users
- [x] Проверка работы триггеров для автоматического создания записей
- [x] Корректная обработка поля auth_date и других преобразований данных
- [x] Создание/обновление настроек пользователя в таблице user_settings
- [x] Удаление устаревшего кода обхода ограничений внешних ключей
- [x] Проверка работы с новыми и существующими пользователями
- [x] Корректная инициализация SDK Telegram Mini Apps через init()
- [x] Использование retrieveLaunchParams для получения данных пользователя
- [x] Надежное создание пользователя в Supabase (в auth.users и public.users)
- [x] Функциональность postEvent('web_app_request_fullscreen') для полноэкранного режима
- [x] Упрощенная панель отладки с табами для логов и initData
- [x] Проверка обработки различных ошибок SDK и Telegram WebApp
- [x] Кнопки копирования данных в буфер обмена в панели отладки

## Навигация по проекту
- Авторизация: интеграция Telegram auth с Supabase
- Отладка: компонент DebugPanel для просмотра состояния приложения
- Telegram интеграция: TelegramContext для взаимодействия с Telegram WebApp
- Supabase: таблицы users, logs для хранения данных пользователей и логирования

## Консистентность флоу
- Инициализация Telegram WebApp при загрузке страницы
- Получение данных пользователя из Telegram
- Создание/обновление пользователя в таблице users
- Логирование событий в консоль и в таблицу logs
- Отображение информации в дебаг-панели

## Что сделано
- Создана утилита логирования с записью в Supabase
- Реализован TelegramContext для работы с Telegram WebApp
- Настроен AuthContext для управления авторизацией
- Создан компонент дебаг-панели для отладки
- Настроены отступы для корректного отображения в Telegram Mini App
- Добавлена вкладка Viewport и Safe Area в дебаг-панели
- Добавлены кнопки копирования во все блоки дебаг-панели
- Улучшена интеграция с Telegram SDK, корректно обрабатываются safeAreaInsets
- Исправлена интеграция Telegram и Supabase для корректного создания пользователей
- Добавлены CSS-переменные для работы с отступами в Telegram Mini App
- Создан скрипт для тестового создания пользователя через CLI (create-test-user.js)
- Успешно протестировано создание пользователя через прямой SQL-запрос к Supabase
- Интегрирована логика создания пользователя из CLI-скрипта в код приложения
- Исправлена обработка поля auth_date для корректного сохранения в числовом формате
- Добавлена поддержка создания настроек пользователя при первой регистрации
- Добавлено использование UUID для генерации ID новых пользователей
- Реализован запрос на полноэкранный режим через web_app_request_fullscreen с fallback на expand()
- Реализована надежная система создания/обновления пользователя в таблице users в Supabase
- Улучшена обработка ошибок при сохранении данных в Supabase
- Добавлена возможность отображения пользовательских данных в дебаг-панели через пропсы
- Улучшена функция createUserInSupabase для надежного создания пользователей
- Добавлена проверка работы триггеров и ручное создание записей при необходимости
- Улучшена обработка ошибок и логирование процесса создания пользователя
- Исправлена обработка поля auth_date и другие преобразования данных
- Удален устаревший код создания пользователя в обход auth.users
- Отладочная панель теперь не содержит лишней информации и фокусируется на необходимых данных
- При возникновении ошибок SDK есть запасные механизмы получения данных пользователя через WebApp

## Последнее обновление
- Дата: 13.11.2024
- Время: 22:30 

# Краткосрочный план разработки

## Приоритетные задачи

### 1. Исправление ошибки создания пользователя в Supabase
- **Причина**: Ограничение внешнего ключа `users_id_fkey` требует, чтобы ID пользователя сначала был создан в `auth.users`
- **Решение**: Модифицировать процесс создания/обновления пользователя
  - Сначала использовать Auth API для создания записи в `auth.users`
  - Затем создать/обновить запись в `public.users` с тем же ID
  - Обновить скрипт тестирования для проверки корректной работы

### 2. Улучшение функциональности Telegram Mini App
- **Задача**: Добавить поддержку методов для улучшения UX
  - Реализовать корректную обработку `web_app_setup_closing_behavior`
  - Настроить `web_app_setup_swipe_behavior` для отключения вертикальных свайпов
  - Внедрить `web_app_request_content_safe_area` для корректных отступов на всех страницах

### 3. Документация и тестирование
- Обновить документацию по методам Telegram Mini App
- Создать тестовые сценарии для проверки новой функциональности
- Задокументировать структуру таблиц в Supabase и зависимости между ними

## Чеклист проверок

- [x] Пользователь корректно создается в Supabase с данными из Telegram
- [x] Настройки пользователя сохраняются в таблице `user_settings`
- [x] Приложение корректно обрабатывает отступы (content safe area)
- [x] Отключены вертикальные свайпы для закрытия приложения
- [x] Подтверждение закрытия приложения работает корректно
- [x] Документация актуализирована

## Навигация по файлам

| Файл | Описание | Статус |
|------|----------|--------|
| src/components/TelegramViewportStyle.tsx | Инициализация SDK и запрос fullscreen | ✅ |
| src/context/TelegramContext.tsx | Логика работы с данными пользователя | ✅ |
| src/hooks/useSupabase.ts | Хук для работы с Supabase | ✅ |
| src/components/Debug/DebugPanel.tsx | Панель отладки с поддержкой пропсов | ✅ |
| src/components/Debug/DebugPanel.module.css | Стили для панели отладки | ✅ |
| create-test-user.js | CLI-скрипт для создания тестового пользователя | ✅ |
| docs/TELEGRAM_SDK_FIXES.md | Документация по исправлениям | ✅ |

# Краткий план по интеграции с Telegram Mini Apps SDK

## Текущие правки (май 2024)

1. ✅ Настройка получения данных через SDK аналогично DebugPanel
2. ✅ Исправление методов работы с полноэкранным режимом (web_app_request_fullscreen)
3. ✅ Добавление обработки событий content_safe_area_changed
4. ✅ Настройка вертикальных свайпов (web_app_setup_swipe_behavior)
allow_vertical_swipe5. ✅ Добавление поддержки темы оформления Telegram (web_app_request_theme)

## Чек-лист для проверки

- [ ] Данные из Telegram корректно отображаются в дебаг-панели
- [ ] Полноэкранный режим работает на мобильных устройствах
- [ ] Корректно отображаются отступы с учетом безопасной зоны контента
- [ ] Вертикальные свайпы работают для закрытия приложения
- [ ] Приложение адаптируется к теме Telegram (светлая/темная)

## Архитектура взаимодействия с Telegram SDK

```
┌─────────────────────┐      ┌───────────────────┐
│ TelegramContext.tsx │◄────►│ Telegram SDK      │
└─────────┬───────────┘      └───────────────────┘
          │
          ▼
┌─────────────────────┐      ┌───────────────────┐
│ page.tsx (YogaApp)  │◄────►│ DebugPanel.tsx    │
└─────────────────────┘      └───────────────────┘
```

## Используемые методы из методов_тг_full.md

- web_app_request_fullscreen
- web_app_request_content_safe_area
- web_app_setup_swipe_behavior
- web_app_ready
- web_app_request_theme

## Примечания для тестирования

- Проверить на iOS и Android устройствах
- Проверить на iPhone с челкой для корректности отступов
- Проверить работу на разных версиях Telegram (>=6.1)
- Проверить работу вертикальных свайпов с параметром `allow_vertical_swipe: true`
- Проверить переключение между светлой и темной темами Telegram

## CSS переменные для интеграции с Telegram

### Отступы безопасной зоны
```css
:root {
  --safe-area-top: 30px;
  --safe-area-right: 0px;
  --safe-area-bottom: 0px;
  --safe-area-left: 0px;
  
  /* Альтернативный формат */
  --tg-content-safe-area-top: 30px;
  --tg-content-safe-area-right: 0px;
  --tg-content-safe-area-bottom: 0px;
  --tg-content-safe-area-left: 0px;
}
```

### Параметры темы
```css
:root {
  /* Прямые переменные из Telegram */
  --tg-theme-bg-color: #ffffff;
  --tg-theme-text-color: #000000;
  --tg-theme-hint-color: #999999;
  --tg-theme-link-color: #2481cc;
  --tg-theme-button-color: #2481cc;
  --tg-theme-button-text-color: #ffffff;
  
  /* Упрощенные алиасы */
  --tg-theme-bg: #ffffff;
  --tg-theme-text: #000000;
  --tg-theme-hint: #999999;
  --tg-theme-link: #2481cc;
  --tg-theme-button: #2481cc;
  --tg-theme-button-text: #ffffff;
}
```

# Краткосрочный план: Документирование проекта

**Задача:** Создать детальный `architecture.md`.

**Чеклист:**
- [ ] Создать `docs/TASK.md`.
- [ ] Проанализировать структуру проекта.
- [ ] Описать схему БД (таблицы, поля, связи).
- [ ] Описать логику авторизации (Telegram -> Supabase).
- [ ] Описать маршрутизацию (Next.js App Router).
- [ ] Описать управление состоянием (Context API, Hooks).
- [ ] Описать интеграцию с Telegram Mini App SDK.
- [ ] Описать ключевые компоненты и их назначение.
- [ ] Описать использование переменных окружения.
- [ ] Описать процесс деплоя (Vercel).
- [ ] Описать важные скрипты и файлы.
- [ ] Описать общий поток данных для отображения на главной странице.
- [ ] Добавить структуру файлов в `architecture.md`.
- [ ] Поставить метку последней верификации. 

# КРАТКОСРОЧНЫЙ ПЛАН

## Текущая задача: Рефакторинг page.tsx и устранение ошибок

### Шаги:
1. Исправление ошибки с window is not defined в продакшене
   - Проблема связана с попыткой доступа к window в SSR
   - Необходимо обернуть все обращения к window в проверку typeof window !== 'undefined'

2. Разбиение page.tsx на компоненты:
   - MainContent: основное содержимое приложения
   - AppNavigation: навигационное меню
   - FloatingDebugButton: кнопка вызова отладочной панели
   - TelegramThemeManager: управление темой и CSS-переменными
   - TelegramSafeAreaHandler: обработка событий изменения безопасной зоны
   - LoggingProvider: компонент для расширенного логирования

3. Создание утилит для стилей:
   - cssUtils.ts: безопасное управление CSS-переменными с учетом SSR

### Чеклист выполнения:
- [x] Ошибка "window is not defined" исправлена
- [x] Создан компонент TelegramThemeManager для управления темой
- [x] Создан компонент TelegramSafeAreaHandler для обработки событий
- [x] Создан компонент LoggingProvider для логирования
- [x] Создана утилита cssUtils.ts
- [x] Размер page.tsx уменьшен за счет выделения компонентов
- [x] Все проверки typeof window !== 'undefined' добавлены
- [x] Все проверки typeof document !== 'undefined' добавлены

## Следующие шаги:
1. Тестирование в продакшен среде
2. Дальнейшее разбиение крупных компонентов
3. Улучшение типизации и документирование компонентов

# КРАТКОСРОЧНОЕ ПЛАНИРОВАНИЕ

## Текущая задача
- Настроить корректную авторизацию пользователей с записью в таблицу users
- Исправить проблемы с дебаг-панелью (лаги, ошибки в консоли)
- Добавить в дебаг-панель кнопки быстрого копирования
- Исправить отступы content safe area на главной странице
- Настроить корректное отображение Telegram Mini App в fullscreen режиме
- Использовать web_app_request_fullscreen вместо устаревшего метода expand()
- Обеспечить сохранение данных пользователя в таблице users
- Улучшить функцию createUserInSupabase в TelegramContext.tsx
- Обеспечить надежное создание пользователей в Supabase с учетом ограничений внешних ключей
- Привести код к единому паттерну, используемому в тестовых скриптах
- Улучшить обработку ошибок и логирование процесса создания/обновления пользователя
- Исправить интеграцию с Telegram Mini Apps SDK
- Обеспечить корректное получение данных пользователя из Telegram
- Упростить панель отладки с фокусом на логи и initData
- Реализовать функциональность полноэкранного режима

## Чеклисты проверок
- [x] Проверить создание пользователя в таблице users при открытии приложения
- [x] Исправить дебаг-панель (добавить кнопки копирования, устранить ошибки)
- [x] Настроить корректные отступы для контента (safeAreaInsets и contentSafeAreaInsets)
- [x] Проверить интеграцию с Telegram Mini Apps SDK (init, саф-ареа и др.)
- [x] Проверить работу логирования в таблицу logs и вывод логов в дебаг-панель
- [x] Протестировать создание пользователя через CLI (прямой запрос к Supabase)
- [x] Интегрировать логику создания пользователя из CLI-скрипта в код приложения
- [x] Реализовать переключение в fullscreen режим через web_app_request_fullscreen
- [x] Обеспечить корректное сохранение данных пользователя в таблице users независимо от RLS
- [x] Создание пользователя в auth.users перед созданием в public.users
- [x] Проверка работы триггеров для автоматического создания записей
- [x] Корректная обработка поля auth_date и других преобразований данных
- [x] Создание/обновление настроек пользователя в таблице user_settings
- [x] Удаление устаревшего кода обхода ограничений внешних ключей
- [x] Проверка работы с новыми и существующими пользователями
- [x] Корректная инициализация SDK Telegram Mini Apps через init()
- [x] Использование retrieveLaunchParams для получения данных пользователя
- [x] Надежное создание пользователя в Supabase (в auth.users и public.users)
- [x] Функциональность postEvent('web_app_request_fullscreen') для полноэкранного режима
- [x] Упрощенная панель отладки с табами для логов и initData
- [x] Проверка обработки различных ошибок SDK и Telegram WebApp
- [x] Кнопки копирования данных в буфер обмена в панели отладки

## Навигация по проекту
- Авторизация: интеграция Telegram auth с Supabase
- Отладка: компонент DebugPanel для просмотра состояния приложения
- Telegram интеграция: TelegramContext для взаимодействия с Telegram WebApp
- Supabase: таблицы users, logs для хранения данных пользователей и логирования

## Консистентность флоу
- Инициализация Telegram WebApp при загрузке страницы
- Получение данных пользователя из Telegram
- Создание/обновление пользователя в таблице users
- Логирование событий в консоль и в таблицу logs
- Отображение информации в дебаг-панели

## Что сделано
- Создана утилита логирования с записью в Supabase
- Реализован TelegramContext для работы с Telegram WebApp
- Настроен AuthContext для управления авторизацией
- Создан компонент дебаг-панели для отладки
- Настроены отступы для корректного отображения в Telegram Mini App
- Добавлена вкладка Viewport и Safe Area в дебаг-панели
- Добавлены кнопки копирования во все блоки дебаг-панели
- Улучшена интеграция с Telegram SDK, корректно обрабатываются safeAreaInsets
- Исправлена интеграция Telegram и Supabase для корректного создания пользователей
- Добавлены CSS-переменные для работы с отступами в Telegram Mini App
- Создан скрипт для тестового создания пользователя через CLI (create-test-user.js)
- Успешно протестировано создание пользователя через прямой SQL-запрос к Supabase
- Интегрирована логика создания пользователя из CLI-скрипта в код приложения
- Исправлена обработка поля auth_date для корректного сохранения в числовом формате
- Добавлена поддержка создания настроек пользователя при первой регистрации
- Добавлено использование UUID для генерации ID новых пользователей
- Реализован запрос на полноэкранный режим через web_app_request_fullscreen с fallback на expand()
- Реализована надежная система создания/обновления пользователя в таблице users в Supabase
- Улучшена обработка ошибок при сохранении данных в Supabase
- Добавлена возможность отображения пользовательских данных в дебаг-панели через пропсы
- Улучшена функция createUserInSupabase для надежного создания пользователей
- Добавлена проверка работы триггеров и ручное создание записей при необходимости
- Улучшена обработка ошибок и логирование процесса создания пользователя
- Исправлена обработка поля auth_date и другие преобразования данных
- Удален устаревший код создания пользователя в обход auth.users
- Отладочная панель теперь не содержит лишней информации и фокусируется на необходимых данных
- При возникновении ошибок SDK есть запасные механизмы получения данных пользователя через WebApp

## Последнее обновление
- Дата: 13.11.2024
- Время: 22:30 

# Краткосрочный план разработки

## Приоритетные задачи

### 1. Исправление ошибки создания пользователя в Supabase
- **Причина**: Ограничение внешнего ключа `users_id_fkey` требует, чтобы ID пользователя сначала был создан в `auth.users`
- **Решение**: Модифицировать процесс создания/обновления пользователя
  - Сначала использовать Auth API для создания записи в `auth.users`
  - Затем создать/обновить запись в `public.users` с тем же ID
  - Обновить скрипт тестирования для проверки корректной работы

### 2. Улучшение функциональности Telegram Mini App
- **Задача**: Добавить поддержку методов для улучшения UX
  - Реализовать корректную обработку `web_app_setup_closing_behavior`
  - Настроить `web_app_setup_swipe_behavior` для отключения вертикальных свайпов
  - Внедрить `web_app_request_content_safe_area` для корректных отступов на всех страницах

### 3. Документация и тестирование
- Обновить документацию по методам Telegram Mini App
- Создать тестовые сценарии для проверки новой функциональности
- Задокументировать структуру таблиц в Supabase и зависимости между ними

## Чеклист проверок

- [x] Пользователь корректно создается в Supabase с данными из Telegram
- [x] Настройки пользователя сохраняются в таблице `user_settings`
- [x] Приложение корректно обрабатывает отступы (content safe area)
- [x] Отключены вертикальные свайпы для закрытия приложения
- [x] Подтверждение закрытия приложения работает корректно
- [x] Документация актуализирована

## Навигация по файлам

| Файл | Описание | Статус |
|------|----------|--------|
| src/components/TelegramViewportStyle.tsx | Инициализация SDK и запрос fullscreen | ✅ |
| src/context/TelegramContext.tsx | Логика работы с данными пользователя | ✅ |
| src/hooks/useSupabase.ts | Хук для работы с Supabase | ✅ |
| src/components/Debug/DebugPanel.tsx | Панель отладки с поддержкой пропсов | ✅ |
| src/components/Debug/DebugPanel.module.css | Стили для панели отладки | ✅ |
| create-test-user.js | CLI-скрипт для создания тестового пользователя | ✅ |
| docs/TELEGRAM_SDK_FIXES.md | Документация по исправлениям | ✅ |

# Краткий план по интеграции с Telegram Mini Apps SDK

## Текущие правки (май 2024)

1. ✅ Настройка получения данных через SDK аналогично DebugPanel
2. ✅ Исправление методов работы с полноэкранным режимом (web_app_request_fullscreen)
3. ✅ Добавление обработки событий content_safe_area_changed
4. ✅ Настройка вертикальных свайпов (web_app_setup_swipe_behavior)
allow_vertical_swipe5. ✅ Добавление поддержки темы оформления Telegram (web_app_request_theme)

## Чек-лист для проверки

- [ ] Данные из Telegram корректно отображаются в дебаг-панели
- [ ] Полноэкранный режим работает на мобильных устройствах
- [ ] Корректно отображаются отступы с учетом безопасной зоны контента
- [ ] Вертикальные свайпы работают для закрытия приложения
- [ ] Приложение адаптируется к теме Telegram (светлая/темная)

## Архитектура взаимодействия с Telegram SDK

```
┌─────────────────────┐      ┌───────────────────┐
│ TelegramContext.tsx │◄────►│ Telegram SDK      │
└─────────┬───────────┘      └───────────────────┘
          │
          ▼
┌─────────────────────┐      ┌───────────────────┐
│ page.tsx (YogaApp)  │◄────►│ DebugPanel.tsx    │
└─────────────────────┘      └───────────────────┘
```

## Используемые методы из методов_тг_full.md

- web_app_request_fullscreen
- web_app_request_content_safe_area
- web_app_setup_swipe_behavior
- web_app_ready
- web_app_request_theme

## Примечания для тестирования

- Проверить на iOS и Android устройствах
- Проверить на iPhone с челкой для корректности отступов
- Проверить работу на разных версиях Telegram (>=6.1)
- Проверить работу вертикальных свайпов с параметром `allow_vertical_swipe: true`
- Проверить переключение между светлой и темной темами Telegram

## CSS переменные для интеграции с Telegram

### Отступы безопасной зоны
```css
:root {
  --safe-area-top: 30px;
  --safe-area-right: 0px;
  --safe-area-bottom: 0px;
  --safe-area-left: 0px;
  
  /* Альтернативный формат */
  --tg-content-safe-area-top: 30px;
  --tg-content-safe-area-right: 0px;
  --tg-content-safe-area-bottom: 0px;
  --tg-content-safe-area-left: 0px;
}
```

### Параметры темы
```css
:root {
  /* Прямые переменные из Telegram */
  --tg-theme-bg-color: #ffffff;
  --tg-theme-text-color: #000000;
  --tg-theme-hint-color: #999999;
  --tg-theme-link-color: #2481cc;
  --tg-theme-button-color: #2481cc;
  --tg-theme-button-text-color: #ffffff;
  
  /* Упрощенные алиасы */
  --tg-theme-bg: #ffffff;
  --tg-theme-text: #000000;
  --tg-theme-hint: #999999;
  --tg-theme-link: #2481cc;
  --tg-theme-button: #2481cc;
  --tg-theme-button-text: #ffffff;
}
```

# Краткосрочный план: Документирование проекта

**Задача:** Создать детальный `architecture.md`.

**Чеклист:**
- [ ] Создать `docs/TASK.md`.
- [ ] Проанализировать структуру проекта.
- [ ] Описать схему БД (таблицы, поля, связи).
- [ ] Описать логику авторизации (Telegram -> Supabase).
- [ ] Описать маршрутизацию (Next.js App Router).
- [ ] Описать управление состоянием (Context API, Hooks).
- [ ] Описать интеграцию с Telegram Mini App SDK.
- [ ] Описать ключевые компоненты и их назначение.
- [ ] Описать использование переменных окружения.
- [ ] Описать процесс деплоя (Vercel).
- [ ] Описать важные скрипты и файлы.
- [ ] Описать общий поток данных для отображения на главной странице.
- [ ] Добавить структуру файлов в `architecture.md`.
- [ ] Поставить метку последней верификации. 

# КРАТКОСРОЧНЫЙ ПЛАН

## Текущая задача: Рефакторинг page.tsx и устранение ошибок

### Шаги:
1. Исправление ошибки с window is not defined в продакшене
   - Проблема связана с попыткой доступа к window в SSR
   - Необходимо обернуть все обращения к window в проверку typeof window !== 'undefined'

2. Разбиение page.tsx на компоненты:
   - MainContent: основное содержимое приложения
   - AppNavigation: навигационное меню
   - FloatingDebugButton: кнопка вызова отладочной панели
   - TelegramThemeManager: управление темой и CSS-переменными
   - TelegramSafeAreaHandler: обработка событий изменения безопасной зоны
   - LoggingProvider: компонент для расширенного логирования

3. Создание утилит для стилей:
   - cssUtils.ts: безопасное управление CSS-переменными с учетом SSR

### Чеклист выполнения:
- [x] Ошибка "window is not defined" исправлена
- [x] Создан компонент TelegramThemeManager для управления темой
- [x] Создан компонент TelegramSafeAreaHandler для обработки событий
- [x] Создан компонент LoggingProvider для логирования
- [x] Создана утилита cssUtils.ts
- [x] Размер page.tsx уменьшен за счет выделения компонентов
- [x] Все проверки typeof window !== 'undefined' добавлены
- [x] Все проверки typeof document !== 'undefined' добавлены

## Следующие шаги:
1. Тестирование в продакшен среде
2. Дальнейшее разбиение крупных компонентов
3. Улучшение типизации и документирование компонентов

# КРАТКОСРОЧНОЕ ПЛАНИРОВАНИЕ

## Текущая задача
- Настроить корректную авторизацию пользователей с записью в таблицу users
- Исправить проблемы с дебаг-панелью (лаги, ошибки в консоли)
- Добавить в дебаг-панель кнопки быстрого копирования
- Исправить отступы content safe area на главной странице
- Настроить корректное отображение Telegram Mini App в fullscreen режиме
- Использовать web_app_request_fullscreen вместо устаревшего метода expand()
- Обеспечить сохранение данных пользователя в таблице users
- Улучшить функцию createUserInSupabase в TelegramContext.tsx
- Обеспечить надежное создание пользователей в Supabase с учетом ограничений внешних ключей
- Привести код к единому паттерну, используемому в тестовых скриптах
- Улучшить обработку ошибок и логирование процесса создания/обновления пользователя
- Исправить интеграцию с Telegram Mini Apps SDK
- Обеспечить корректное получение данных пользователя из Telegram
- Упростить панель отладки с фокусом на логи и initData
- Реализовать функциональность полноэкранного режима

## Чеклисты проверок
- [x] Проверить создание пользователя в таблице users при открытии приложения
- [x] Исправить дебаг-панель (добавить кнопки копирования, устранить ошибки)
- [x] Настроить корректные отступы для контента (safeAreaInsets и contentSafeAreaInsets)
- [x] Проверить интеграцию с Telegram Mini Apps SDK (init, саф-ареа и др.)
- [x] Проверить работу логирования в таблицу logs и вывод логов в дебаг-панель
- [x] Протестировать создание пользователя через CLI (прямой запрос к Supabase)
- [x] Интегрировать логику создания пользователя из CLI-скрипта в код приложения
- [x] Реализовать переключение в fullscreen режим через web_app_request_fullscreen
- [x] Обеспечить корректное сохранение данных пользователя в таблице users независимо от RLS
- [x] Создание пользователя в auth.users перед созданием в public.users
- [x] Проверка работы триггеров для автоматического создания записей
- [x] Корректная обработка поля auth_date и других преобразований данных
- [x] Создание/обновление настроек пользователя в таблице user_settings
- [x] Удаление устаревшего кода обхода ограничений внешних ключей
- [x] Проверка работы с новыми и существующими пользователями
- [x] Корректная инициализация SDK Telegram Mini Apps через init()
- [x] Использование retrieveLaunchParams для получения данных пользователя
- [x] Надежное создание пользователя в Supabase (в auth.users и public.users)
- [x] Функциональность postEvent('web_app_request_fullscreen') для полноэкранного режима
- [x] Упрощенная панель отладки с табами для логов и initData
- [x] Проверка обработки различных ошибок SDK и Telegram WebApp
- [x] Кнопки копирования данных в буфер обмена в панели отладки

## Навигация по проекту
- Авторизация: интеграция Telegram auth с Supabase
- Отладка: компонент DebugPanel для просмотра состояния приложения
- Telegram интеграция: TelegramContext для взаимодействия с Telegram WebApp
- Supabase: таблицы users, logs для хранения данных пользователей и логирования

## Консистентность флоу
- Инициализация Telegram WebApp при загрузке страницы
- Получение данных пользователя из Telegram
- Создание/обновление пользователя в таблице users
- Логирование событий в консоль и в таблицу logs
- Отображение информации в дебаг-панели

## Что сделано
- Создана утилита логирования с записью в Supabase
- Реализован TelegramContext для работы с Telegram WebApp
- Настроен AuthContext для управления авторизацией
- Создан компонент дебаг-панели для отладки
- Настроены отступы для корректного отображения в Telegram Mini App
- Добавлена вкладка Viewport и Safe Area в дебаг-панели
- Добавлены кнопки копирования во все блоки дебаг-панели
- Улучшена интеграция с Telegram SDK, корректно обрабатываются safeAreaInsets
- Исправлена интеграция Telegram и Supabase для корректного создания пользователей
- Добавлены CSS-переменные для работы с отступами в Telegram Mini App
- Создан скрипт для тестового создания пользователя через CLI (create-test-user.js)
- Успешно протестировано создание пользователя через прямой SQL-запрос к Supabase
- Интегрирована логика создания пользователя из CLI-скрипта в код приложения
- Исправлена обработка поля auth_date для корректного сохранения в числовом формате
- Добавлена поддержка создания настроек пользователя при первой регистрации
- Добавлено использование UUID для генерации ID новых пользователей
- Реализован запрос на полноэкранный режим через web_app_request_fullscreen с fallback на expand()
- Реализована надежная система создания/обновления пользователя в таблице users в Supabase
- Улучшена обработка ошибок при сохранении данных в Supabase
- Добавлена возможность отображения пользовательских данных в дебаг-панели через пропсы
- Улучшена функция createUserInSupabase для надежного создания пользователей
- Добавлена проверка работы триггеров и ручное создание записей при необходимости
- Улучшена обработка ошибок и логирование процесса создания пользователя
- Исправлена обработка поля auth_date и другие преобразования данных
- Удален устаревший код создания пользователя в обход auth.users
- Отладочная панель теперь не содержит лишней информации и фокусируется на необходимых данных
- При возникновении ошибок SDK есть запасные механизмы получения данных пользователя через WebApp

## Последнее обновление
- Дата: 19.05.2024
- Время: 20:30 

# Краткосрочный план разработки

## Приоритетные задачи

### 1. Исправление ошибки создания пользователя в Supabase
- **Причина**: Ограничение внешнего ключа `users_id_fkey` требует, чтобы ID пользователя сначала был создан в `auth.users`
- **Решение**: Модифицировать процесс создания/обновления пользователя
  - Сначала использовать Auth API для создания записи в `auth.users`
  - Затем создать/обновить запись в `public.users` с тем же ID
  - Обновить скрипт тестирования для проверки корректной работы

### 2. Улучшение функциональности Telegram Mini App
- **Задача**: Добавить поддержку методов для улучшения UX
  - Реализовать корректную обработку `web_app_setup_closing_behavior`
  - Настроить `web_app_setup_swipe_behavior` для отключения вертикальных свайпов
  - Внедрить `web_app_request_content_safe_area` для корректных отступов на всех страницах

### 3. Документация и тестирование
- Обновить документацию по методам Telegram Mini App
- Создать тестовые сценарии для проверки новой функциональности
- Задокументировать структуру таблиц в Supabase и зависимости между ними

## Чеклист проверок

- [x] Пользователь корректно создается в Supabase с данными из Telegram
- [x] Настройки пользователя сохраняются в таблице `user_settings`
- [x] Приложение корректно обрабатывает отступы (content safe area)
- [x] Отключены вертикальные свайпы для закрытия приложения
- [x] Подтверждение закрытия приложения работает корректно
- [x] Документация актуализирована

## Навигация по файлам

| Файл | Описание | Статус |
|------|----------|--------|
| src/components/TelegramViewportStyle.tsx | Инициализация SDK и запрос fullscreen | ✅ |
| src/context/TelegramContext.tsx | Логика работы с данными пользователя | ✅ |
| src/hooks/useSupabase.ts | Хук для работы с Supabase | ✅ |
| src/components/Debug/DebugPanel.tsx | Панель отладки с поддержкой пропсов | ✅ |
| src/components/Debug/DebugPanel.module.css | Стили для панели отладки | ✅ |
| create-test-user.js | CLI-скрипт для создания тестового пользователя | ✅ |
| docs/TELEGRAM_SDK_FIXES.md | Документация по исправлениям | ✅ |

# Краткий план по интеграции с Telegram Mini Apps SDK

## Текущие правки (май 2024)

1. ✅ Настройка получения данных через SDK аналогично DebugPanel
2. ✅ Исправление методов работы с полноэкранным режимом (web_app_request_fullscreen)
3. ✅ Добавление обработки событий content_safe_area_changed
4. ✅ Настройка вертикальных свайпов (web_app_setup_swipe_behavior)
allow_vertical_swipe5. ✅ Добавление поддержки темы оформления Telegram (web_app_request_theme)

## Чек-лист для проверки

- [ ] Данные из Telegram корректно отображаются в дебаг-панели
- [ ] Полноэкранный режим работает на мобильных устройствах
- [ ] Корректно отображаются отступы с учетом безопасной зоны контента
- [ ] Вертикальные свайпы работают для закрытия приложения
- [ ] Приложение адаптируется к теме Telegram (светлая/темная)

## Архитектура взаимодействия с Telegram SDK

```
┌─────────────────────┐      ┌───────────────────┐
│ TelegramContext.tsx │◄────►│ Telegram SDK      │
└─────────┬───────────┘      └───────────────────┘
          │
          ▼
┌─────────────────────┐      ┌───────────────────┐
│ page.tsx (YogaApp)  │◄────►│ DebugPanel.tsx    │
└─────────────────────┘      └───────────────────┘
```

## Используемые методы из методов_тг_full.md

- web_app_request_fullscreen
- web_app_request_content_safe_area
- web_app_setup_swipe_behavior
- web_app_ready
- web_app_request_theme

## Примечания для тестирования

- Проверить на iOS и Android устройствах
- Проверить на iPhone с челкой для корректности отступов
- Проверить работу на разных версиях Telegram (>=6.1)
- Проверить работу вертикальных свайпов с параметром `allow_vertical_swipe: true`
- Проверить переключение между светлой и темной темами Telegram

## CSS переменные для интеграции с Telegram

### Отступы безопасной зоны
```css
:root {
  --safe-area-top: 30px;
  --safe-area-right: 0px;
  --safe-area-bottom: 0px;
  --safe-area-left: 0px;
  
  /* Альтернативный формат */
  --tg-content-safe-area-top: 30px;
  --tg-content-safe-area-right: 0px;
  --tg-content-safe-area-bottom: 0px;
  --tg-content-safe-area-left: 0px;
}
```

### Параметры темы
```css
:root {
  /* Прямые переменные из Telegram */
  --tg-theme-bg-color: #ffffff;
  --tg-theme-text-color: #000000;
  --tg-theme-hint-color: #999999;
  --tg-theme-link-color: #2481cc;
  --tg-theme-button-color: #2481cc;
  --tg-theme-button-text-color: #ffffff;
  
  /* Упрощенные алиасы */
  --tg-theme-bg: #ffffff;
  --tg-theme-text: #000000;
  --tg-theme-hint: #999999;
  --tg-theme-link: #2481cc;
  --tg-theme-button: #2481cc;
  --tg-theme-button-text: #ffffff;
}
```

# Краткосрочный план: Документирование проекта

**Задача:** Создать детальный `architecture.md`.

**Чеклист:**
- [ ] Создать `docs/TASK.md`.
- [ ] Проанализировать структуру проекта.
- [ ] Описать схему БД (таблицы, поля, связи).
- [ ] Описать логику авторизации (Telegram -> Supabase).
- [ ] Описать маршрутизацию (Next.js App Router).
- [ ] Описать управление состоянием (Context API, Hooks).
- [ ] Описать интеграцию с Telegram Mini App SDK.
- [ ] Описать ключевые компоненты и их назначение.
- [ ] Описать использование переменных окружения.
- [ ] Описать процесс деплоя (Vercel).
- [ ] Описать важные скрипты и файлы.
- [ ] Описать общий поток данных для отображения на главной странице.
- [ ] Добавить структуру файлов в `architecture.md`.
- [ ] Поставить метку последней верификации. 

# КРАТКОСРОЧНЫЙ ПЛАН

## Текущая задача: Рефакторинг page.tsx и устранение ошибок

### Шаги:
1. Исправление ошибки с window is not defined в продакшене
   - Проблема связана с попыткой доступа к window в SSR
   - Необходимо обернуть все обращения к window в проверку typeof window !== 'undefined'

2. Разбиение page.tsx на компоненты:
   - MainContent: основное содержимое приложения
   - AppNavigation: навигационное меню
   - FloatingDebugButton: кнопка вызова отладочной панели
   - TelegramThemeManager: управление темой и CSS-переменными
   - TelegramSafeAreaHandler: обработка событий изменения безопасной зоны
   - LoggingProvider: компонент для расширенного логирования

3. Создание утилит для стилей:
   - cssUtils.ts: безопасное управление CSS-переменными с учетом SSR

### Чеклист выполнения:
- [x] Ошибка "window is not defined" исправлена
- [x] Создан компонент TelegramThemeManager для управления темой
- [x] Создан компонент TelegramSafeAreaHandler для обработки событий
- [x] Создан компонент LoggingProvider для логирования
- [x] Создана утилита cssUtils.ts
- [x] Размер page.tsx уменьшен за счет выделения компонентов
- [x] Все проверки typeof window !== 'undefined' добавлены
- [x] Все проверки typeof document !== 'undefined' добавлены

## Следующие шаги:
1. Тестирование в продакшен среде
2. Дальнейшее разбиение крупных компонентов
3. Улучшение типизации и документирование компонентов

# КРАТКОСРОЧНОЕ ПЛАНИРОВАНИЕ

## Текущая задача
- Настроить корректную авторизацию пользователей с записью в таблицу users
- Исправить проблемы с дебаг-панелью (лаги, ошибки в консоли)
- Добавить в дебаг-панель кнопки быстрого копирования
- Исправить отступы content safe area на главной странице
- Настроить корректное отображение Telegram Mini App в fullscreen режиме
- Использовать web_app_request_fullscreen вместо устаревшего метода expand()
- Обеспечить сохранение данных пользователя в таблице users
- Улучшить функцию createUserInSupabase в TelegramContext.tsx
- Обеспечить надежное создание пользователей в Supabase с учетом ограничений внешних ключей
- Привести код к единому паттерну, используемому в тестовых скриптах
- Улучшить обработку ошибок и логирование процесса создания/обновления пользователя
- Исправить интеграцию с Telegram Mini Apps SDK
- Обеспечить корректное получение данных пользователя из Telegram
- Упростить панель отладки с фокусом на логи и initData
- Реализовать функциональность полноэкранного режима

## Чеклисты проверок
- [x] Проверить создание пользователя в таблице users при открытии приложения
- [x] Исправить дебаг-панель (добавить кнопки копирования, устранить ошибки)
- [x] Настроить корректные отступы для контента (safeAreaInsets и contentSafeAreaInsets)
- [x] Проверить интеграцию с Telegram Mini Apps SDK (init, саф-ареа и др.)
- [x] Проверить работу логирования в таблицу logs и вывод логов в дебаг-панель
- [x] Протестировать создание пользователя через CLI (прямой запрос к Supabase)
- [x] Интегрировать логику создания пользователя из CLI-скрипта в код приложения
- [x] Реализовать переключение в fullscreen режим через web_app_request_fullscreen
- [x] Обеспечить корректное сохранение данных пользователя в таблице users независимо от RLS
- [x] Создание пользователя в auth.users перед созданием в public.users
- [x] Проверка работы триггеров для автоматического создания записей
- [x] Корректная обработка поля auth_date и других преобразований данных
- [x] Создание/обновление настроек пользователя в таблице user_settings
- [x] Удаление устаревшего кода обхода ограничений внешних ключей
- [x] Проверка работы с новыми и существующими пользователями
- [x] Корректная инициализация SDK Telegram Mini Apps через init()
- [x] Использование retrieveLaunchParams для получения данных пользователя
- [x] Надежное создание пользователя в Supabase (в auth.users и public.users)
- [x] Функциональность postEvent('web_app_request_fullscreen') для полноэкранного режима
- [x] Упрощенная панель отладки с табами для логов и initData
- [x] Проверка обработки различных ошибок SDK и Telegram WebApp
- [x] Кнопки копирования данных в буфер обмена в панели отладки

## Навигация по проекту
- Авторизация: интеграция Telegram auth с Supabase
- Отладка: компонент DebugPanel для просмотра состояния приложения
- Telegram интеграция: TelegramContext для взаимодействия с Telegram WebApp
- Supabase: таблицы users, logs для хранения данных пользователей и логирования

## Консистентность флоу
- Инициализация Telegram WebApp при загрузке страницы
- Получение данных пользователя из Telegram
- Создание/обновление пользователя в таблице users
- Логирование событий в консоль и в таблицу logs
- Отображение информации в дебаг-панели

## Что сделано
- Создана утилита логирования с записью в Supabase
- Реализован TelegramContext для работы с Telegram WebApp
- Настроен AuthContext для управления авторизацией
- Создан компонент дебаг-панели для отладки
- Настроены отступы для корректного отображения в Telegram Mini App
- Добавлена вкладка Viewport и Safe Area в дебаг-панели
- Добавлены кнопки копирования во все блоки дебаг-панели
- Улучшена интеграция с Telegram SDK, корректно обрабатываются safeAreaInsets
- Исправлена интеграция Telegram и Supabase для корректного создания пользователей
- Добавлены CSS-переменные для работы с отступами в Telegram Mini App
- Создан скрипт для тестового создания пользователя через CLI (create-test-user.js)
- Успешно протестировано создание пользователя через прямой SQL-запрос к Supabase
- Интегрирована логика создания пользователя из CLI-скрипта в код приложения
- Исправлена обработка поля auth_date для корректного сохранения в числовом формате
- Добавлена поддержка создания настроек пользователя при первой регистрации
- Добавлено использование UUID для генерации ID новых пользователей
- Реализован запрос на полноэкранный режим через web_app_request_fullscreen с fallback на expand()
- Реализована надежная система создания/обновления пользователя в таблице users в Supabase
- Улучшена обработка ошибок при сохранении данных в Supabase
- Добавлена возможность отображения пользовательских данных в дебаг-панели через пропсы
- Улучшена функция createUserInSupabase для надежного создания пользователей
- Добавлена проверка работы триггеров и ручное создание записей при необходимости
- Улучшена обработка ошибок и логирование процесса создания пользователя
- Исправлена обработка поля auth_date и другие преобразования данных
- Удален устаревший код создания пользователя в обход auth.users
- Отладочная панель теперь не содержит лишней информации и фокусируется на необходимых данных
- При возникновении ошибок SDK есть запасные механизмы получения данных пользователя через WebApp

## Последнее обновление
- Дата: 19.05.2024
- Время: 20:30 

# Краткосрочный план разработки

## Приоритетные задачи

### 1. Исправление ошибки создания пользователя в Supabase
- **Причина**: Ограничение внешнего ключа `users_id_fkey` требует, чтобы ID пользователя сначала был создан в `auth.users`
- **Решение**: Модифицировать процесс создания/обновления пользователя
  - Сначала использовать Auth API для создания записи в `auth.users`
  - Затем создать/обновить запись в `public.users` с тем же ID
  - Обновить скрипт тестирования для проверки корректной работы

### 2. Улучшение функциональности Telegram Mini App
- **Задача**: Добавить поддержку методов для улучшения UX
  - Реализовать корректную обработку `web_app_setup_closing_behavior`
  - Настроить `web_app_setup_swipe_behavior` для отключения вертикальных свайпов
  - Внедрить `web_app_request_content_safe_area` для корректных отступов на всех страницах

### 3. Документация и тестирование
- Обновить документацию по методам Telegram Mini App
- Создать тестовые сценарии для проверки новой функциональности
- Задокументировать структуру таблиц в Supabase и зависимости между ними

## Чеклист проверок

- [x] Пользователь корректно создается в Supabase с данными из Telegram
- [x] Настройки пользователя сохраняются в таблице `user_settings`
- [x] Приложение корректно обрабатывает отступы (content safe area)
- [x] Отключены вертикальные свайпы для закрытия приложения
- [x] Подтверждение закрытия приложения работает корректно
- [x] Документация актуализирована

## Навигация по файлам

| Файл | Описание | Статус |
|------|----------|--------|
| src/components/TelegramViewportStyle.tsx | Инициализация SDK и запрос fullscreen | ✅ |
| src/context/TelegramContext.tsx | Логика работы с данными пользователя | ✅ |
| src/hooks/useSupabase.ts | Хук для работы с Supabase | ✅ |
| src/components/Debug/DebugPanel.tsx | Панель отладки с поддержкой пропсов | ✅ |
| src/components/Debug/DebugPanel.module.css | Стили для панели отладки | ✅ |
| create-test-user.js | CLI-скрипт для создания тестового пользователя | ✅ |
| docs/TELEGRAM_SDK_FIXES.md | Документация по исправлениям | ✅ |

# Краткий план по интеграции с Telegram Mini Apps SDK

## Текущие правки (май 2024)

1. ✅ Настройка получения данных через SDK аналогично DebugPanel
2. ✅ Исправление методов работы с полноэкранным режимом (web_app_request_fullscreen)
3. ✅ Добавление обработки событий content_safe_area_changed
4. ✅ Настройка вертикальных свайпов (web_app_setup_swipe_behavior)
allow_vertical_swipe5. ✅ Добавление поддержки темы оформления Telegram (web_app_request_theme)

## Чек-лист для проверки

- [ ] Данные из Telegram корректно отображаются в дебаг-панели
- [ ] Полноэкранный режим работает на мобильных устройствах
- [ ] Корректно отображаются отступы с учетом безопасной зоны контента
- [ ] Вертикальные свайпы работают для закрытия приложения
- [ ] Приложение адаптируется к теме Telegram (светлая/темная)

## Архитектура взаимодействия с Telegram SDK

```
┌─────────────────────┐      ┌───────────────────┐
│ TelegramContext.tsx │◄────►│ Telegram SDK      │
└─────────┬───────────┘      └───────────────────┘
          │
          ▼
┌─────────────────────┐      ┌───────────────────┐
│ page.tsx (YogaApp)  │◄────►│ DebugPanel.tsx    │
└─────────────────────┘      └───────────────────┘
```

## Используемые методы из методов_тг_full.md

- web_app_request_fullscreen
- web_app_request_content_safe_area
- web_app_setup_swipe_behavior
- web_app_ready
- web_app_request_theme

## Примечания для тестирования

- Проверить на iOS и Android устройствах
- Проверить на iPhone с челкой для корректности отступов
- Проверить работу на разных версиях Telegram (>=6.1)
- Проверить работу вертикальных свайпов с параметром `allow_vertical_swipe: true`
- Проверить переключение между светлой и темной темами Telegram

## CSS переменные для интеграции с Telegram

### Отступы безопасной зоны
```css
:root {
  --safe-area-top: 30px;
  --safe-area-right: 0px;
  --safe-area-bottom: 0px;
  --safe-area-left: 0px;
  
  /* Альтернативный формат */
  --tg-content-safe-area-top: 30px;
  --tg-content-safe-area-right: 0px;
  --tg-content-safe-area-bottom: 0px;
  --tg-content-safe-area-left: 0px;
}
```

### Параметры темы
```css
:root {
  /* Прямые переменные из Telegram */
  --tg-theme-bg-color: #ffffff;
  --tg-theme-text-color: #000000;
  --tg-theme-hint-color: #999999;
  --tg-theme-link-color: #2481cc;
  --tg-theme-button-color: #2481cc;
  --tg-theme-button-text-color: #ffffff;
  
  /* Упрощенные алиасы */
  --tg-theme-bg: #ffffff;
  --tg-theme-text: #000000;
  --tg-theme-hint: #999999;
  --tg-theme-link: #2481cc;
  --tg-theme-button: #2481cc;
  --tg-theme-button-text: #ffffff;
}
```

# Краткосрочный план: Документирование проекта

**Задача:** Создать детальный `architecture.md`.

**Чеклист:**
- [ ] Создать `docs/TASK.md`.
- [ ] Проанализировать структуру проекта.
- [ ] Описать схему БД (таблицы, поля, связи).
- [ ] Описать логику авторизации (Telegram -> Supabase).
- [ ] Описать маршрутизацию (Next.js App Router).
- [ ] Описать управление состоянием (Context API, Hooks).
- [ ] Описать интеграцию с Telegram Mini App SDK.
- [ ] Описать ключевые компоненты и их назначение.
- [ ] Описать использование переменных окружения.
- [ ] Описать процесс деплоя (Vercel).
- [ ] Описать важные скрипты и файлы.
- [ ] Описать общий поток данных для отображения на главной странице.
- [ ] Добавить структуру файлов в `architecture.md`.
- [ ] Поставить метку последней верификации. 

# КРАТКОСРОЧНЫЙ ПЛАН

## Текущая задача: Рефакторинг page.tsx и устранение ошибок

### Шаги:
1. Исправление ошибки с window is not defined в продакшене
   - Проблема связана с попыткой доступа к window в SSR
   - Необходимо обернуть все обращения к window в проверку typeof window !== 'undefined'

2. Разбиение page.tsx на компоненты:
   - MainContent: основное содержимое приложения
   - AppNavigation: навигационное меню
   - FloatingDebugButton: кнопка вызова отладочной панели
   - TelegramThemeManager: управление темой и CSS-переменными
   - TelegramSafeAreaHandler: обработка событий изменения безопасной зоны
   - LoggingProvider: компонент для расширенного логирования

3. Создание утилит для стилей:
   - cssUtils.ts: безопасное управление CSS-переменными с учетом SSR

### Чеклист выполнения:
- [x] Ошибка "window is not defined" исправлена
- [x] Создан компонент TelegramThemeManager для управления темой
- [x] Создан компонент TelegramSafeAreaHandler для обработки событий
- [x] Создан компонент LoggingProvider для логирования
- [x] Создана утилита cssUtils.ts
- [x] Размер page.tsx уменьшен за счет выделения компонентов
- [x] Все проверки typeof window !== 'undefined' добавлены
- [x] Все проверки typeof document !== 'undefined' добавлены

## Следующие шаги:
1. Тестирование в продакшен среде
2. Дальнейшее разбиение крупных компонентов
3. Улучшение типизации и документирование компонентов

# КРАТКОСРОЧНОЕ ПЛАНИРОВАНИЕ

## Текущая задача
- Настроить корректную авторизацию пользователей с записью в таблицу users
- Исправить проблемы с дебаг-панелью (лаги, ошибки в консоли)
- Добавить в дебаг-панель кнопки быстрого копирования
- Исправить отступы content safe area на главной странице
- Настроить корректное отображение Telegram Mini App в fullscreen режиме
- Использовать web_app_request_fullscreen вместо устаревшего метода expand()
- Обеспечить сохранение данных пользователя в таблице users
- Улучшить функцию createUserInSupabase в TelegramContext.tsx
- Обеспечить надежное создание пользователей в Supabase с учетом ограничений внешних ключей
- Привести код к единому паттерну, используемому в тестовых скриптах
- Улучшить обработку ошибок и логирование процесса создания/обновления пользователя
- Исправить интеграцию с Telegram Mini Apps SDK
- Обеспечить корректное получение данных пользователя из Telegram
- Упростить панель отладки с фокусом на логи и initData
- Реализовать функциональность полноэкранного режима

## Чеклисты проверок
- [x] Проверить создание пользователя в таблице users при открытии приложения
- [x] Исправить дебаг-панель (добавить кнопки копирования, устранить ошибки)
- [x] Настроить корректные отступы для контента (safeAreaInsets и contentSafeAreaInsets)
- [x] Проверить интеграцию с Telegram Mini Apps SDK (init, саф-ареа и др.)
- [x] Проверить работу логирования в таблицу logs и вывод логов в дебаг-панель
- [x] Протестировать создание пользователя через CLI (прямой запрос к Supabase)
- [x] Интегрировать логику создания пользователя из CLI-скрипта в код приложения
- [x] Реализовать переключение в fullscreen режим через web_app_request_fullscreen
- [x] Обеспечить корректное сохранение данных пользователя в таблице users независимо от RLS
- [x] Создание пользователя в auth.users перед созданием в public.users
- [x] Проверка работы триггеров для автоматического создания записей
- [x] Корректная обработка поля auth_date и других преобразований данных
- [x] Создание/обновление настроек пользователя в таблице user_settings
- [x] Удаление устаревшего кода обхода ограничений внешних ключей
- [x] Проверка работы с новыми и существующими пользователями
- [x] Корректная инициализация SDK Telegram Mini Apps через init()
- [x] Использование retrieveLaunchParams для получения данных пользователя
- [x] Надежное создание пользователя в Supabase (в auth.users и public.users)
- [x] Функциональность postEvent('web_app_request_fullscreen') для полноэкранного режима
- [x] Упрощенная панель отладки с табами для логов и initData
- [x] Проверка обработки различных ошибок SDK и Telegram WebApp
- [x] Кнопки копирования данных в буфер обмена в панели отладки

## Навигация по проекту
- Авторизация: интеграция Telegram auth с Supabase
- Отладка: компонент DebugPanel для просмотра состояния приложения
- Telegram интеграция: TelegramContext для взаимодействия с Telegram WebApp
- Supabase: таблицы users, logs для хранения данных пользователей и логирования

## Консистентность флоу
- Инициализация Telegram WebApp при загрузке страницы
- Получение данных пользователя из Telegram
- Создание/обновление пользователя в таблице users
- Логирование событий в консоль и в таблицу logs
- Отображение информации в дебаг-панели

## Что сделано
- Создана утилита логирования с записью в Supabase
- Реализован TelegramContext для работы с Telegram WebApp
- Настроен AuthContext для управления авторизацией
- Создан компонент дебаг-панели для отладки
- Настроены отступы для корректного отображения в Telegram Mini App
- Добавлена вкладка Viewport и Safe Area в дебаг-панели
- Добавлены кнопки копирования во все блоки дебаг-панели
- Улучшена интеграция с Telegram SDK, корректно обрабатываются safeAreaInsets
- Исправлена интеграция Telegram и Supabase для корректного создания пользователей
- Добавлены CSS-переменные для работы с отступами в Telegram Mini App
- Создан скрипт для тестового создания пользователя через CLI (create-test-user.js)
- Успешно протестировано создание пользователя через прямой SQL-запрос к Supabase
- Интегрирована логика создания пользователя из CLI-скрипта в код приложения
- Исправлена обработка поля auth_date для корректного сохранения в числовом формате
- Добавлена поддержка создания настроек пользователя при первой регистрации
- Добавлено использование UUID для генерации ID новых пользователей
- Реализован запрос на полноэкранный режим через web_app_request_fullscreen с fallback на expand()
- Реализована надежная система создания/обновления пользователя в таблице users в Supabase
- Улучшена обработка ошибок при сохранении данных в Supabase
- Добавлена возможность отображения пользовательских данных в дебаг-панели через пропсы
- Улучшена функция createUserInSupabase для надежного создания пользователей
- Добавлена проверка работы триггеров и ручное создание записей при необходимости
- Улучшена обработка ошибок и логирование процесса создания пользователя
- Исправлена обработка поля auth_date и другие преобразования данных
- Удален устаревший код создания пользователя в обход auth.users
- Отладочная панель теперь не содержит лишней информации и фокусируется на необходимых данных
- При возникновении ошибок SDK есть запасные механизмы получения данных пользователя через WebApp

## Последнее обновление
- Дата: 19.05.2024
- Время: 20:30 

# Краткосрочный план разработки

## Приоритетные задачи

### 1. Исправление ошибки создания пользователя в Supabase
- **Причина**: Ограничение внешнего ключа `users_id_fkey` требует, чтобы ID пользователя сначала был создан в `auth.users`
- **Решение**: Модифицировать процесс создания/обновления пользователя
  - Сначала использовать Auth API для создания записи в `auth.users`
  - Затем создать/обновить запись в `public.users` с тем же ID
  - Обновить скрипт тестирования для проверки корректной работы

### 2. Улучшение функциональности Telegram Mini App
- **Задача**: Добавить поддержку методов для улучшения UX
  - Реализовать корректную обработку `web_app_setup_closing_behavior`
  - Настроить `web_app_setup_swipe_behavior` для отключения вертикальных свайпов
  - Внедрить `web_app_request_content_safe_area` для корректных отступов на всех страницах

### 3. Документация и тестирование
- Обновить документацию по методам Telegram Mini App
- Создать тестовые сценарии для проверки новой функциональности
- Задокументировать структуру таблиц в Supabase и зависимости между ними

## Чеклист проверок

- [x] Пользователь корректно создается в Supabase с данными из Telegram
- [x] Настройки пользователя сохраняются в таблице `user_settings`
- [x] Приложение корректно обрабатывает отступы (content safe area)
- [x] Отключены вертикальные свайпы для закрытия приложения
- [x] Подтверждение закрытия приложения работает корректно
- [x] Документация актуализирована

## Навигация по файлам

| Файл | Описание | Статус |
|------|----------|--------|
| src/components/TelegramViewportStyle.tsx | Инициализация SDK и запрос fullscreen | ✅ |
| src/context/TelegramContext.tsx | Логика работы с данными пользователя | ✅ |
| src/hooks/useSupabase.ts | Хук для работы с Supabase | ✅ |
| src/components/Debug/DebugPanel.tsx | Панель отладки с поддержкой пропсов | ✅ |
| src/components/Debug/DebugPanel.module.css | Стили для панели отладки | ✅ |
| create-test-user.js | CLI-скрипт для создания тестового пользователя | ✅ |
| docs/TELEGRAM_SDK_FIXES.md | Документация по исправлениям | ✅ |

# Краткий план по интеграции с Telegram Mini Apps SDK

## Текущие правки (май 2024)

1. ✅ Настройка получения данных через SDK аналогично DebugPanel
2. ✅ Исправление методов работы с полноэкранным режимом (web_app_request_fullscreen)
3. ✅ Добавление обработки событий content_safe_area_changed
4. ✅ Настройка вертикальных свайпов (web_app_setup_swipe_behavior)
allow_vertical_swipe5. ✅ Добавление поддержки темы оформления Telegram (web_app_request_theme)

## Чек-лист для проверки

- [ ] Данные из Telegram корректно отображаются в дебаг-панели
- [ ] Полноэкранный режим работает на мобильных устройствах
- [ ] Корректно отображаются отступы с учетом безопасной зоны контента
- [ ] Вертикальные свайпы работают для закрытия приложения
- [ ] Приложение адаптируется к теме Telegram (светлая/темная)

## Архитектура взаимодействия с Telegram SDK

```
┌─────────────────────┐      ┌───────────────────┐
│ TelegramContext.tsx │◄────►│ Telegram SDK      │
└─────────┬───────────┘      └───────────────────┘
          │
          ▼
┌─────────────────────┐      ┌───────────────────┐
│ page.tsx (YogaApp)  │◄────►│ DebugPanel.tsx    │
└─────────────────────┘      └───────────────────┘
```

## Используемые методы из методов_тг_full.md

- web_app_request_fullscreen
- web_app_request_content_safe_area
- web_app_setup_swipe_behavior
- web_app_ready
- web_app_request_theme

## Примечания для тестирования

- Проверить на iOS и Android устройствах
- Проверить на iPhone с челкой для корректности отступов
- Проверить работу на разных версиях Telegram (>=6.1)
- Проверить работу вертикальных свайпов с параметром `allow_vertical_swipe: true`
- Проверить переключение между светлой и темной темами Telegram

## CSS переменные для интеграции с Telegram

### Отступы безопасной зоны
```css
:root {
  --safe-area-top: 30px;
  --safe-area-right: 0px;
  --safe-area-bottom: 0px;
  --safe-area-left: 0px;
  
  /* Альтернативный формат */
  --tg-content-safe-area-top: 30px;
  --tg-content-safe-area-right: 0px;
  --tg-content-safe-area-bottom: 0px;
  --tg-content-safe-area-left: 0px;
}
```

### Параметры темы
```css
:root {
  /* Прямые переменные из Telegram */
  --tg-theme-bg-color: #ffffff;
  --tg-theme-text-color: #000000;
  --tg-theme-hint-color: #999999;
  --tg-theme-link-color: #2481cc;
  --tg-theme-button-color: #2481cc;
  --tg-theme-button-text-color: #ffffff;
  
  /* Упрощенные алиасы */
  --tg-theme-bg: #ffffff;
  --tg-theme-text: #000000;
  --tg-theme-hint: #999999;
  --tg-theme-link: #2481cc;
  --tg-theme-button: #2481cc;
  --tg-theme-button-text: #ffffff;
}
```

# Краткосрочный план: Документирование проекта

**Задача:** Создать детальный `architecture.md`.

**Чеклист:**
- [ ] Создать `docs/TASK.md`.
- [ ] Проанализировать структуру проекта.
- [ ] Описать схему БД (таблицы, поля, связи).
- [ ] Описать логику авторизации (Telegram -> Supabase).
- [ ] Описать маршрутизацию (Next.js App Router).
- [ ] Описать управление состоянием (Context API, Hooks).
- [ ] Описать интеграцию с Telegram Mini App SDK.
- [ ] Описать ключевые компоненты и их назначение.
- [ ] Описать использование переменных окружения.
- [ ] Описать процесс деплоя (Vercel).
- [ ] Описать важные скрипты и файлы.
- [ ] Описать общий поток данных для отображения на главной странице.
- [ ] Добавить структуру файлов в `architecture.md`.
- [ ] Поставить метку последней верификации. 

# КРАТКОСРОЧНЫЙ ПЛАН

## Текущая задача: Рефакторинг page.tsx и устранение ошибок

### Шаги:
1. Исправление ошибки с window is not defined в продакшене
   - Проблема связана с попыткой доступа к window в SSR
   - Необходимо обернуть все обращения к window в проверку typeof window !== 'undefined'

2. Разбиение page.tsx на компоненты:
   - MainContent: основное содержимое приложения
   - AppNavigation: навигационное меню
   - FloatingDebugButton: кнопка вызова отладочной панели
   - TelegramThemeManager: управление темой и CSS-переменными
   - TelegramSafeAreaHandler: обработка событий изменения безопасной зоны
   - LoggingProvider: компонент для расширенного логирования

3. Создание утилит для стилей:
   - cssUtils.ts: безопасное управление CSS-переменными с учетом SSR

### Чеклист выполнения:
- [x] Ошибка "window is not defined" исправлена
- [x] Создан компонент TelegramThemeManager для управления темой
- [x] Создан компонент TelegramSafeAreaHandler для обработки событий
- [x] Создан компонент LoggingProvider для логирования
- [x] Создана утилита cssUtils.ts
- [x] Размер page.tsx уменьшен за счет выделения компонентов
- [x] Все проверки typeof window !== 'undefined' добавлены
- [x] Все проверки typeof document !== 'undefined' добавлены

## Следующие шаги:
1. Тестирование в продакшен среде
2. Дальнейшее разбиение крупных компонентов
3. Улучшение типизации и документирование компонентов

# КРАТКОСРОЧНОЕ ПЛАНИРОВАНИЕ

## Текущая задача
- Настроить корректную авторизацию пользователей с записью в таблицу users
- Исправить проблемы с дебаг-панелью (лаги, ошибки в консоли)
- Добавить в дебаг-панель кнопки быстрого копирования
- Исправить отступы content safe area на главной странице
- Настроить корректное отображение Telegram Mini App в fullscreen режиме
- Использовать web_app_request_fullscreen вместо устаревшего метода expand()
- Обеспечить сохранение данных пользователя в таблице users
- Улучшить функцию createUserInSupabase в TelegramContext.tsx
- Обеспечить надежное создание пользователей в Supabase с учетом ограничений внешних ключей
- Привести код к единому паттерну, используемому в тестовых скриптах
- Улучшить обработку ошибок и логирование процесса создания/обновления пользователя
- Исправить интеграцию с Telegram Mini Apps SDK
- Обеспечить корректное получение данных пользователя из Telegram
- Упростить панель отладки с фокусом на логи и initData
- Реализовать функциональность полноэкранного режима

## Чеклисты проверок
- [x] Проверить создание пользователя в таблице users при открытии приложения
- [x] Исправить дебаг-панель (добавить кнопки копирования, устранить ошибки)
- [x] Настроить корректные отступы для контента (safeAreaInsets и contentSafeAreaInsets)
- [x] Проверить интеграцию с Telegram Mini Apps SDK (init, саф-ареа и др.)
- [x] Проверить работу логирования в таблицу logs и вывод логов в дебаг-панель
- [x] Протестировать создание пользователя через CLI (прямой запрос к Supabase)
- [x] Интегрировать логику создания пользователя из CLI-скрипта в код приложения
- [x] Реализовать переключение в fullscreen режим через web_app_request_fullscreen
- [x] Обеспечить корректное сохранение данных пользователя в таблице users независимо от RLS
- [x] Создание пользователя в auth.users перед созданием в public.users
- [x] Проверка работы триггеров для автоматического создания записей
- [x] Корректная обработка поля auth_date и других преобразований данных
- [x] Создание/обновление настроек пользователя в таблице user_settings
- [x] Удаление устаревшего кода обхода ограничений внешних ключей
- [x] Проверка работы с новыми и существующими пользователями
- [x] Корректная инициализация SDK Telegram Mini Apps через init()
- [x] Использование retrieveLaunchParams для получения данных пользователя
- [x] Надежное создание пользователя в Supabase (в auth.users и public.users)
- [x] Функциональность postEvent('web_app_request_fullscreen') для полноэкранного режима
- [x] Упрощенная панель отладки с табами для логов и initData
- [x] Проверка обработки различных ошибок SDK и Telegram WebApp
- [x] Кнопки копирования данных в буфер обмена в панели отладки

## Навигация по проекту
- Авторизация: интеграция Telegram auth с Supabase
- Отладка: компонент DebugPanel для просмотра состояния приложения
- Telegram интеграция: TelegramContext для взаимодействия с Telegram WebApp
- Supabase: таблицы users, logs для хранения данных пользователей и логирования

## Консистентность флоу
- Инициализация Telegram WebApp при загрузке страницы
- Получение данных пользователя из Telegram
- Создание/обновление пользователя в таблице users
- Логирование событий в консоль и в таблицу logs
- Отображение информации в дебаг-панели

## Что сделано
- Создана утилита логирования с записью в Supabase
- Реализован TelegramContext для работы с Telegram WebApp
- Настроен AuthContext для управления авторизацией
- Создан компонент дебаг-панели для отладки
- Настроены отступы для корректного отображения в Telegram Mini App
- Добавлена вкладка Viewport и Safe Area в дебаг-панели
- Добавлены кнопки копирования во все блоки дебаг-панели
- Улучшена интеграция с Telegram SDK, корректно обрабатываются safeAreaInsets
- Исправлена интеграция Telegram и Supabase для корректного создания пользователей
- Добавлены CSS-переменные для работы с отступами в Telegram Mini App
- Создан скрипт для тестового создания пользователя через CLI (create-test-user.js)
- Успешно протестировано создание пользователя через прямой SQL-запрос к Supabase
- Интегрирована логика создания пользователя из CLI-скрипта в код приложения
- Исправлена обработка поля auth_date для корректного сохранения в числовом формате
- Добавлена поддержка создания настроек пользователя при первой регистрации
- Добавлено использование UUID для генерации ID новых пользователей
- Реализован запрос на полноэкранный режим через web_app_request_fullscreen с fallback на expand()
- Реализована надежная система создания/обновления пользователя в таблице users в Supabase
- Улучшена обработка ошибок при сохранении данных в Supabase
- Добавлена возможность отображения пользовательских данных в дебаг-панели через пропсы
- Улучшена функция createUserInSupabase для надежного создания пользователей
- Добавлена проверка работы триггеров и ручное создание записей при необходимости
- Улучшена обработка ошибок и логирование процесса создания пользователя
- Исправлена обработка поля auth_date и другие преобразования данных
- Удален устаревший код создания пользователя в обход auth.users
- Отладочная панель теперь не содержит лишней информации и фокусируется на необходимых данных
- При возникновении ошибок SDK есть запасные механизмы получения данных пользователя через WebApp

## Последнее обновление
- Дата: 19.05.2024
- Время: 20:30 

# Краткосрочный план разработки

## Приоритетные задачи

### 1. Исправление ошибки создания пользователя в Supabase
- **Причина**: Ограничение внешнего ключа `users_id_fkey` требует, чтобы ID пользователя сначала был создан в `auth.users`
- **Решение**: Модифицировать процесс создания/обновления пользователя
  - Сначала использовать Auth API для создания записи в `auth.users`
  - Затем создать/обновить запись в `public.users` с тем же ID
  - Обновить скрипт тестирования для проверки корректной работы

### 2. Улучшение функциональности Telegram Mini App
- **Задача**: Добавить поддержку методов для улучшения UX
  - Реализовать корректную обработку `web_app_setup_closing_behavior`
  - Настроить `web_app_setup_swipe_behavior` для отключения вертикальных свайпов
  - Внедрить `web_app_request_content_safe_area` для корректных отступов на всех страницах

### 3. Документация и тестирование
- Обновить документацию по методам Telegram Mini App
- Создать тестовые сценарии для проверки новой функциональности
- Задокументировать структуру таблиц в Supabase и зависимости между ними

## Чеклист проверок

- [x] Пользователь корректно создается в Supabase с данными из Telegram
- [x] Настройки пользователя сохраняются в таблице `user_settings`
- [x] Приложение корректно обрабатывает отступы (content safe area)
- [x] Отключены вертикальные свайпы для закрытия приложения
- [x] Подтверждение закрытия приложения работает корректно
- [x] Документация актуализирована

## Навигация по файлам

| Файл | Описание | Статус |
|------|----------|--------|
| src/components/TelegramViewportStyle.tsx | Инициализация SDK и запрос fullscreen | ✅ |
| src/context/TelegramContext.tsx | Логика работы с данными пользователя | ✅ |
| src/hooks/useSupabase.ts | Хук для работы с Supabase | ✅ |
| src/components/Debug/DebugPanel.tsx | Панель отладки с поддержкой пропсов | ✅ |
| src/components/Debug/DebugPanel.module.css | Стили для панели отладки | ✅ |
| create-test-user.js | CLI-скрипт для создания тестового пользователя | ✅ |
| docs/TELEGRAM_SDK_FIXES.md | Документация по исправлениям | ✅ |

# Краткий план по интеграции с Telegram Mini Apps SDK

## Текущие правки (май 2024)

1. ✅ Настройка получения данных через SDK аналогично DebugPanel
2. ✅ Исправление методов работы с полноэкранным режимом (web_app_request_fullscreen)
3. ✅ Добавление обработки событий content_safe_area_changed
4. ✅ Настройка вертикальных свайпов (web_app_setup_swipe_behavior)
allow_vertical_swipe5. ✅ Добавление поддержки темы оформления Telegram (web_app_request_theme)

## Чек-лист для проверки

- [ ] Данные из Telegram корректно отображаются в дебаг-панели
- [ ] Полноэкранный режим работает на мобильных устройствах
- [ ] Корректно отображаются отступы с учетом безопасной зоны контента
- [ ] Вертикальные свайпы работают для закрытия приложения
- [ ] Приложение адаптируется к теме Telegram (светлая/темная)

## Архитектура взаимодействия с Telegram SDK

```
┌─────────────────────┐      ┌───────────────────┐
│ TelegramContext.tsx │◄────►│ Telegram SDK      │
└─────────┬───────────┘      └───────────────────┘
          │
          ▼
┌─────────────────────┐      ┌───────────────────┐
│ page.tsx (YogaApp)  │◄────►│ DebugPanel.tsx    │
└─────────────────────┘      └───────────────────┘
```

## Используемые методы из методов_тг_full.md

- web_app_request_fullscreen
- web_app_request_content_safe_area
- web_app_setup_swipe_behavior
- web_app_ready
- web_app_request_theme

## Примечания для тестирования

- Проверить на iOS и Android устройствах
- Проверить на iPhone с челкой для корректности отступов
- Проверить работу на разных версиях Telegram (>=6.1)
- Проверить работу вертикальных свайпов с параметром `allow_vertical_swipe: true`
- Проверить переключение между светлой и темной темами Telegram

## CSS переменные для интеграции с Telegram

### Отступы безопасной зоны
```css
:root {
  --safe-area-top: 30px;
  --safe-area-right: 0px;
  --safe-area-bottom: 0px;
  --safe-area-left: 0px;
  
  /* Альтернативный формат */
  --tg-content-safe-area-top: 30px;
  --tg-content-safe-area-right: 0px;
  --tg-content-safe-area-bottom: 0px;
  --tg-content-safe-area-left: 0px;
}
```

### Параметры темы
```css
:root {
  /* Прямые переменные из Telegram */
  --tg-theme-bg-color: #ffffff;
  --tg-theme-text-color: #000000;
  --tg-theme-hint-color: #999999;
  --tg-theme-link-color: #2481cc;
  --tg-theme-button-color: #2481cc;
  --tg-theme-button-text-color: #ffffff;
  
  /* Упрощенные алиасы */
  --tg-theme-bg: #ffffff;
  --tg-theme-text: #000000;
  --tg-theme-hint: #999999;
  --tg-theme-link: #2481cc;
  --tg-theme-button: #2481cc;
  --tg-theme-button-text: #ffffff;
}
```

# Краткосрочный план: Документирование проекта

**Задача:** Создать детальный `architecture.md`.

**Чеклист:**
- [ ] Создать `docs/TASK.md`.
- [ ] Проанализировать структуру проекта.
- [ ] Описать схему БД (таблицы, поля, связи).
- [ ] Описать логику авторизации (Telegram -> Supabase).
- [ ] Описать маршрутизацию (Next.js App Router).
- [ ] Описать управление состоянием (Context API, Hooks).
- [ ] Описать интеграцию с Telegram Mini App SDK.
- [ ] Описать ключевые компоненты и их назначение.
- [ ] Описать использование переменных окружения.
- [ ] Описать процесс деплоя (Vercel).
- [ ] Описать важные скрипты и файлы.
- [ ] Описать общий поток данных для отображения на главной странице.
- [ ] Добавить структуру файлов в `architecture.md`.
- [ ] Поставить метку последней верификации. 

# КРАТКОСРОЧНЫЙ ПЛАН

## Текущая задача: Рефакторинг page.tsx и устранение ошибок

### Шаги:
1. Исправление ошибки с window is not defined в продакшене
   - Проблема связана с попыткой доступа к window в SSR
   - Необходимо обернуть все обращения к window в проверку typeof window !== 'undefined'

2. Разбиение page.tsx на компоненты:
   - MainContent: основное содержимое приложения
   - AppNavigation: навигационное меню
   - FloatingDebugButton: кнопка вызова отладочной панели
   - TelegramThemeManager: управление темой и CSS-переменными
   - TelegramSafeAreaHandler: обработка событий изменения безопасной зоны
   - LoggingProvider: компонент для расширенного логирования

3. Создание утилит для стилей:
   - cssUtils.ts: безопасное управление CSS-переменными с учетом SSR

### Чеклист выполнения:
- [x] Ошибка "window is not defined" исправлена
- [x] Создан компонент TelegramThemeManager для управления темой
- [x] Создан компонент TelegramSafeAreaHandler для обработки событий
- [x] Создан компонент LoggingProvider для логирования
- [x] Создана утилита cssUtils.ts
- [x] Размер page.tsx уменьшен за счет выделения компонентов
- [x] Все проверки typeof window !== 'undefined' добавлены
- [x] Все проверки typeof document !== 'undefined' добавлены

## Следующие шаги:
1. Тестирование в продакшен среде
2. Дальнейшее разбиение крупных компонентов
3. Улучшение типизации и документирование компонентов

# КРАТКОСРОЧНОЕ ПЛАНИРОВАНИЕ

## Текущая задача
- Настроить корректную авторизацию пользователей с записью в таблицу users
- Исправить проблемы с дебаг-панелью (лаги, ошибки в консоли)
- Добавить в дебаг-панель кнопки быстрого копирования
- Исправить отступы content safe area на главной странице
- Настроить корректное отображение Telegram Mini App в fullscreen режиме
- Использовать web_app_request_fullscreen вместо устаревшего метода expand()
- Обеспечить сохранение данных пользователя в таблице users
- Улучшить функцию createUserInSupabase в TelegramContext.tsx
- Обеспечить надежное создание пользователей в Supabase с учетом ограничений внешних ключей
- Привести код к единому паттерну, используемому в тестовых скриптах
- Улучшить обработку ошибок и логирование процесса создания/обновления пользователя
- Исправить интеграцию с Telegram Mini Apps SDK
- Обеспечить корректное получение данных пользователя из Telegram
- Упростить панель отладки с фокусом на логи и initData
- Реализовать функциональность полноэкранного режима

## Чеклисты проверок
- [x] Проверить создание пользователя в таблице users при открытии приложения
- [x] Исправить дебаг-панель (добавить кнопки копирования, устранить ошибки)
- [x] Настроить корректные отступы для контента (safeAreaInsets и contentSafeAreaInsets)
- [x] Проверить интеграцию с Telegram Mini Apps SDK (init, саф-ареа и др.)
- [x] Проверить работу логирования в таблицу logs и вывод логов в дебаг-панель
- [x] Протестировать создание пользователя через CLI (прямой запрос к Supabase)
- [x] Интегрировать логику создания пользователя из CLI-скрипта в код приложения
- [x] Реализовать переключение в fullscreen режим через web_app_request_fullscreen
- [x] Обеспечить корректное сохранение данных пользователя в таблице users независимо от RLS
- [x] Создание пользователя в auth.users перед созданием в public.users
- [x] Проверка работы триггеров для автоматического создания записей
- [x] Корректная обработка поля auth_date и других преобразований данных
- [x] Создание/обновление настроек пользователя в таблице user_settings
- [x] Удаление устаревшего кода обхода ограничений внешних ключей
- [x] Проверка работы с новыми и существующими пользователями
- [x] Корректная инициализация SDK Telegram Mini Apps через init()
- [x] Использование retrieveLaunchParams для получения данных пользователя
- [x] Надежное создание пользователя в Supabase (в auth.users и public.users)
- [x] Функциональность postEvent('web_app_request_fullscreen') для полноэкранного режима
- [x] Упрощенная панель отладки с табами для логов и initData
- [x] Проверка обработки различных ошибок SDK и Telegram WebApp
- [x] Кнопки копирования данных в буфер обмена в панели отладки

## Навигация по проекту
- Авторизация: интеграция Telegram auth с Supabase
- Отладка: компонент DebugPanel для просмотра состояния приложения
- Telegram интеграция: TelegramContext для взаимодействия с Telegram WebApp
- Supabase: таблицы users, logs для хранения данных пользователей и логирования

## Консистентность флоу
- Инициализация Telegram WebApp при загрузке страницы
- Получение данных пользователя из Telegram
- Создание/обновление пользователя в таблице users
- Логирование событий в консоль и в таблицу logs
- Отображение информации в дебаг-панели

## Что сделано
- Создана утилита логирования с записью в Supabase
- Реализован TelegramContext для работы с Telegram WebApp
- Настроен AuthContext для управления авторизацией
- Создан компонент дебаг-панели для отладки
- Настроены отступы для корректного отображения в Telegram Mini App
- Добавлена вкладка Viewport и Safe Area в дебаг-панели
- Добавлены кнопки копирования во все блоки дебаг-панели
- Улучшена интеграция с Telegram SDK, корректно обрабатываются safeAreaInsets
- Исправлена интеграция Telegram и Supabase для корректного создания пользователей
- Добавлены CSS-переменные для работы с отступами в Telegram Mini App
- Создан скрипт для тестового создания пользователя через CLI (create-test-user.js)
- Успешно протестировано создание пользователя через прямой SQL-запрос к Supabase
- Интегрирована логика создания пользователя из CLI-скрипта в код приложения
- Исправлена обработка поля auth_date для корректного сохранения в числовом формате
- Добавлена поддержка создания настроек пользователя при первой регистрации
- Добавлено использование UUID для генерации ID новых пользователей
- Реализован запрос на полноэкранный режим через web_app_request_fullscreen с fallback на expand()
- Реализована надежная система создания/обновления пользователя в таблице users в Supabase
- Улучшена обработка ошибок при сохранении данных в Supabase
- Добавлена возможность отображения пользовательских данных в дебаг-панели через пропсы
- Улучшена функция createUserInSupabase для надежного создания пользователей
- Добавлена проверка работы триггеров и ручное создание записей при необходимости
- Улучшена обработка ошибок и логирование процесса создания пользователя
- Исправлена обработка поля auth_date и другие преобразования данных
- Удален устаревший код создания пользователя в обход auth.users
- Отладочная панель теперь не содержит лишней информации и фокусируется на необходимых данных
- При возникновении ошибок SDK есть запасные механизмы получения данных пользователя через WebApp

## Последнее обновление
- Дата: 19.05.2024
- Время: 20:30 

# Краткосрочный план разработки

## Приоритетные задачи

### 1. Исправление ошибки создания пользователя в Supabase
- **Причина**: Ограничение внешнего ключа `users_id_fkey` требует, чтобы ID пользователя сначала был создан в `auth.users`
- **Решение**: Модифицировать процесс создания/обновления пользователя
  - Сначала использовать Auth API для создания записи в `auth.users`
  - Затем создать/обновить запись в `public.users` с тем же ID
  - Обновить скрипт тестирования для проверки корректной работы

### 2. Улучшение функциональности Telegram Mini App
- **Задача**: Добавить поддержку методов для улучшения UX
  - Реализовать корректную обработку `web_app_setup_closing_behavior`
  - Настроить `web_app_setup_swipe_behavior` для отключения вертикальных свайпов
  - Внедрить `web_app_request_content_safe_area` для корректных отступов на всех страницах

### 3. Документация и тестирование
- Обновить документацию по методам Telegram Mini App
- Создать тестовые сценарии для проверки новой функциональности
- Задокументировать структуру таблиц в Supabase и зависимости между ними

## Чеклист проверок

- [x] Пользователь корректно создается в Supabase с данными из Telegram
- [x] Настройки пользователя сохраняются в таблице `user_settings`
- [x] Приложение корректно обрабатывает отступы (content safe area)
- [x] Отключены вертикальные свайпы для закрытия приложения
- [x] Подтверждение закрытия приложения работает корректно
- [x] Документация актуализирована

## Навигация по файлам

| Файл | Описание | Статус |
|------|----------|--------|
| src/components/TelegramViewportStyle.tsx | Инициализация SDK и запрос fullscreen | ✅ |
| src/context/TelegramContext.tsx | Логика работы с данными пользователя | ✅ |
| src/hooks/useSupabase.ts | Хук для работы с Supabase | ✅ |
| src/components/Debug/DebugPanel.tsx | Панель отладки с поддержкой пропсов | ✅ |
| src/components/Debug/DebugPanel.module.css | Стили для панели отладки | ✅ |
| create-test-user.js | CLI-скрипт для создания тестового пользователя | ✅ |
| docs/TELEGRAM_SDK_FIXES.md | Документация по исправлениям | ✅ |

# Краткий план по интеграции с Telegram Mini Apps SDK

## Текущие правки (май 2024)

1. ✅ Настройка получения данных через SDK аналогично DebugPanel
2. ✅ Исправление методов работы с полноэкранным режимом (web_app_request_fullscreen)
3. ✅ Добавление обработки событий content_safe_area_changed
4. ✅ Настройка вертикальных свайпов (web_app_setup_swipe_behavior)
allow_vertical_swipe5. ✅ Добавление поддержки темы оформления Telegram (web_app_request_theme)

## Чек-лист для проверки

- [ ] Данные из Telegram корректно отображаются в дебаг-панели
- [ ] Полноэкранный режим работает на мобильных устройствах
- [ ] Корректно отображаются отступы с учетом безопасной зоны контента
- [ ] Вертикальные свайпы работают для закрытия приложения
- [ ] Приложение адаптируется к теме Telegram (светлая/темная)

## Архитектура взаимодействия с Telegram SDK

```
┌─────────────────────┐      ┌───────────────────┐
│ TelegramContext.tsx │◄────►│ Telegram SDK      │
└─────────┬───────────┘      └───────────────────┘
          │
          ▼
┌─────────────────────┐      ┌───────────────────┐
│ page.tsx (YogaApp)  │◄────►│ DebugPanel.tsx    │
└─────────────────────┘      └───────────────────┘
```

## Используемые методы из методов_тг_full.md

- web_app_request_fullscreen
- web_app_request_content_safe_area
- web_app_setup_swipe_behavior
- web_app_ready
- web_app_request_theme

## Примечания для тестирования

- Проверить на iOS и Android устройствах
- Проверить на iPhone с челкой для корректности отступов
- Проверить работу на разных версиях Telegram (>=6.1)
- Проверить работу вертикальных свайпов с параметром `allow_vertical_swipe: true`
- Проверить переключение между светлой и темной темами Telegram

## CSS переменные для интеграции с Telegram

### Отступы безопасной зоны
```css
:root {
  --safe-area-top: 30px;
  --safe-area-right: 0px;
  --safe-area-bottom: 0px;
  --safe-area-left: 0px;
  
  /* Альтернативный формат */
  --tg-content-safe-area-top: 30px;
  --tg-content-safe-area-right: 0px;
  --tg-content-safe-area-bottom: 0px;
  --tg-content-safe-area-left: 0px;
}
```

### Параметры темы
```css
:root {
  /* Прямые переменные из Telegram */
  --tg-theme-bg-color: #ffffff;
  --tg-theme-text-color: #000000;
  --tg-theme-hint-color: #999999;
  --tg-theme-link-color: #2481cc;
  --tg-theme-button-color: #2481cc;
  --tg-theme-button-text-color: #ffffff;
  
  /* Упрощенные алиасы */
  --tg-theme-bg: #ffffff;
  --tg-theme-text: #000000;
  --tg-theme-hint: #999999;
  --tg-theme-link: #2481cc;
  --tg-theme-button: #2481cc;
  --tg-theme-button-text: #ffffff;
}
```

# Краткосрочный план: Документирование проекта

**Задача:** Создать детальный `architecture.md`.

**Чеклист:**
- [ ] Создать `docs/TASK.md`.
- [ ] Проанализировать структуру проекта.
- [ ] Описать схему БД (таблицы, поля, связи).
- [ ] Описать логику авторизации (Telegram -> Supabase).
- [ ] Описать маршрутизацию (Next.js App Router).
- [ ] Описать управление состоянием (Context API, Hooks).
- [ ] Описать интеграцию с Telegram Mini App SDK.
- [ ] Описать ключевые компоненты и их назначение.
- [ ] Описать использование переменных окружения.
- [ ] Описать процесс деплоя (Vercel).
- [ ] Описать важные скрипты и файлы.
- [ ] Описать общий поток данных для отображения на главной странице.
- [ ] Добавить структуру файлов в `architecture.md`.
- [ ] Поставить метку последней верификации. 

# КРАТКОСРОЧНЫЙ ПЛАН

## Текущая задача: Рефакторинг page.tsx и устранение ошибок

### Шаги:
1. Исправление ошибки с window is not defined в продакшене
   - Проблема связана с попыткой доступа к window в SSR
   - Необходимо обернуть все обращения к window в проверку typeof window !== 'undefined'

2. Разбиение page.tsx на компоненты:
   - MainContent: основное содержимое приложения
   - AppNavigation: навигационное меню
   - FloatingDebugButton: кнопка вызова отладочной панели
   - TelegramThemeManager: управление темой и CSS-переменными
   - TelegramSafeAreaHandler: обработка событий изменения безопасной зоны
   - LoggingProvider: компонент для расширенного логирования

3. Создание утилит для стилей:
   - cssUtils.ts: безопасное управление CSS-переменными с учетом SSR

### Чеклист выполнения:
- [x] Ошибка "window is not defined" исправлена
- [x] Создан компонент TelegramThemeManager для управления темой
- [x] Создан компонент TelegramSafeAreaHandler для обработки событий
- [x] Создан компонент LoggingProvider для логирования
- [x] Создана утилита cssUtils.ts
- [x] Размер page.tsx уменьшен за счет выделения компонентов
- [x] Все проверки typeof window !== 'undefined' добавлены
- [x] Все проверки typeof document !== 'undefined' добавлены

## Следующие шаги:
1. Тестирование в продакшен среде
2. Дальнейшее разбиение крупных компонентов
3. Улучшение типизации и документирование компонентов

# КРАТКОСРОЧНОЕ ПЛАНИРОВАНИЕ

## Текущая задача
- Настроить корректную авторизацию пользователей с записью в таблицу users
- Исправить проблемы с дебаг-панелью (лаги, ошибки в консоли)
- Добавить в дебаг-панель кнопки быстрого копирования
- Исправить отступы content safe area на главной странице
- Настроить корректное отображение Telegram Mini App в fullscreen режиме
- Использовать web_app_request_fullscreen вместо устаревшего метода expand()
- Обеспечить сохранение данных пользователя в таблице users
- Улучшить функцию createUserInSupabase в TelegramContext.tsx
- Обеспечить надежное создание пользователей в Supabase с учетом ограничений внешних ключей
- Привести код к единому паттерну, используемому в тестовых скриптах
- Улучшить обработку ошибок и логирование процесса создания/обновления пользователя
- Исправить интеграцию с Telegram Mini Apps SDK
- Обеспечить корректное получение данных пользователя из Telegram
- Упростить панель отладки с фокусом на логи и initData
- Реализовать функциональность полноэкранного режима

## Чеклисты проверок
- [x] Проверить создание пользователя в таблице users при открытии приложения
- [x] Исправить дебаг-панель (добавить кнопки копирования, устранить ошибки)
- [x] Настроить корректные отступы для контента (safeAreaInsets и contentSafeAreaInsets)
- [x] Проверить интеграцию с Telegram Mini Apps SDK (init, саф-ареа и др.)
- [x] Проверить работу логирования в таблицу logs и вывод логов в дебаг-панель
- [x] Протестировать создание пользователя через CLI (прямой запрос к Supabase)
- [x] Интегрировать логику создания пользователя из CLI-скрипта в код приложения
- [x] Реализовать переключение в fullscreen режим через web_app_request_fullscreen
- [x] Обеспечить корректное сохранение данных пользователя в таблице users независимо от RLS
- [x] Создание пользователя в auth.users перед созданием в public.users
- [x] Проверка работы триггеров для автоматического создания записей
- [x] Корректная обработка поля auth_date и других преобразований данных
- [x] Создание/обновление настроек пользователя в таблице user_settings
- [x] Удаление устаревшего кода обхода ограничений внешних ключей
- [x] Проверка работы с новыми и существующими пользователями
- [x] Корректная инициализация SDK Telegram Mini Apps через init()
- [x] Использование retrieveLaunchParams для получения данных пользователя
- [x] Надежное создание пользователя в Supabase (в auth.users и public.users)
- [x] Функциональность postEvent('web_app_request_fullscreen') для полноэкранного режима
- [x] Упрощенная панель отладки с табами для логов и initData
- [x] Проверка обработки различных ошибок SDK и Telegram WebApp
- [x] Кнопки копирования данных в буфер обмена в панели отладки

## Навигация по проекту
- Авторизация: интеграция Telegram auth с Supabase
- Отладка: компонент DebugPanel для просмотра состояния приложения
- Telegram интеграция: TelegramContext для взаимодействия с Telegram WebApp
- Supabase: таблицы users, logs для хранения данных пользователей и логирования

## Консистентность флоу
- Инициализация Telegram WebApp при загрузке страницы
- Получение данных пользователя из Telegram
- Создание/обновление пользователя в таблице users
- Логирование событий в консоль и в таблицу logs
- Отображение информации в дебаг-панели

## Что сделано
- Создана утилита логирования с записью в Supabase
- Реализован TelegramContext для работы с Telegram WebApp
- Настроен AuthContext для управления авторизацией
- Создан компонент дебаг-панели для отладки
- Настроены отступы для корректного отображения в Telegram Mini App
- Добавлена вкладка Viewport и Safe Area в дебаг-панели
- Добавлены кнопки копирования во все блоки дебаг-панели
- Улучшена интеграция с Telegram SDK, корректно обрабатываются safeAreaInsets
- Исправлена интеграция Telegram и Supabase для корректного создания пользователей
- Добавлены CSS-переменные для работы с отступами в Telegram Mini App
- Создан скрипт для тестового создания пользователя через CLI (create-test-user.js)
- Успешно протестировано создание пользователя через прямой SQL-запрос к Supabase
- Интегрирована логика создания пользователя из CLI-скрипта в код приложения
- Исправлена обработка поля auth_date для корректного сохранения в числовом формате
- Добавлена поддержка создания настроек пользователя при первой регистрации
- Добавлено использование UUID для генерации ID новых пользователей
- Реализован запрос на полноэкранный режим через web_app_request_fullscreen с fallback на expand()
- Реализована надежная система создания/обновления пользователя в таблице users в Supabase
- Улучшена обработка ошибок при сохранении данных в Supabase
- Добавлена возможность отображения пользовательских данных в дебаг-панели через пропсы
- Улучшена функция createUserInSupabase для надежного создания пользователей
- Добавлена проверка работы триггеров и ручное создание записей при необходимости
- Улучшена обработка ошибок и логирование процесса создания пользователя
- Исправлена обработка поля auth_date и другие преобразования данных
- Удален устаревший код создания пользователя в обход auth.users
- Отладочная панель теперь не содержит лишней информации и фокусируется на необходимых данных
- При возникновении ошибок SDK есть запасные механизмы получения данных пользователя через WebApp

## Последнее обновление
- Дата: 19.05.2024
- Время: 20:30 

# Краткосрочный план разработки

## Приоритетные задачи

### 1. Исправление ошибки создания пользователя в Supabase
- **Причина**: Ограничение внешнего ключа `users_id_fkey` требует, чтобы ID пользователя сначала был создан в `auth.users`
- **Решение**: Модифицировать процесс создания/обновления пользователя
  - Сначала использовать Auth API для создания записи в `auth.users`
  - Затем создать/обновить запись в `public.users` с тем же ID
  - Обновить скрипт тестирования для проверки корректной работы

### 2. Улучшение функциональности Telegram Mini App
- **Задача**: Добавить поддержку методов для улучшения UX
  - Реализовать корректную обработку `web_app_setup_closing_behavior`
  - Настроить `web_app_setup_swipe_behavior` для отключения вертикальных свайпов
  - Внедрить `web_app_request_content_safe_area` для корректных отступов на всех страницах

### 3. Документация и тестирование
- Обновить документацию по методам Telegram Mini App
- Создать тестовые сценарии для проверки новой функциональности
- Задокументировать структуру таблиц в Supabase и зависимости между ними

## Чеклист проверок

- [x] Пользователь корректно создается в Supabase с данными из Telegram
- [x] Настройки пользователя сохраняются в таблице `user_settings`
- [x] Приложение корректно обрабатывает отступы (content safe area)
- [x] Отключены вертикальные свайпы для закрытия приложения
- [x] Подтверждение закрытия приложения работает корректно
- [x] Документация актуализирована

## Навигация по файлам

| Файл | Описание | Статус |
|------|----------|--------|
| src/components/TelegramViewportStyle.tsx | Инициализация SDK и запрос fullscreen | ✅ |
| src/context/TelegramContext.tsx | Логика работы с данными пользователя | ✅ |
| src/hooks/useSupabase.ts | Хук для работы с Supabase | ✅ |
| src/components/Debug/DebugPanel.tsx | Панель отладки с поддержкой пропсов | ✅ |
| src/components/Debug/DebugPanel.module.css | Стили для панели отладки | ✅ |
| create-test-user.js | CLI-скрипт для создания тестового пользователя | ✅ |
| docs/TELEGRAM_SDK_FIXES.md | Документация по исправлениям | ✅ |

# Краткий план по интеграции с Telegram Mini Apps SDK

## Текущие правки (май 2024)

1. ✅ Настройка получения данных через SDK аналогично DebugPanel
2. ✅ Исправление методов работы с полноэкранным режимом (web_app_request_fullscreen)
3. ✅ Добавление обработки событий content_safe_area_changed
4. ✅ Настройка вертикальных свайпов (web_app_setup_swipe_behavior)
allow_vertical_swipe5. ✅ Добавление поддержки темы оформления Telegram (web_app_request_theme)

## Чек-лист для проверки

- [ ] Данные из Telegram корректно отображаются в дебаг-панели
- [ ] Полноэкранный режим работает на мобильных устройствах
- [ ] Корректно отображаются отступы с учетом безопасной зоны контента
- [ ] Вертикальные свайпы работают для закрытия приложения
- [ ] Приложение адаптируется к теме Telegram (светлая/темная)

## Архитектура взаимодействия с Telegram SDK

```
┌─────────────────────┐      ┌───────────────────┐
│ TelegramContext.tsx │◄────►│ Telegram SDK      │
└─────────┬───────────┘      └───────────────────┘
          │
          ▼
┌─────────────────────┐      ┌───────────────────┐
│ page.tsx (YogaApp)  │◄────►│ DebugPanel.tsx    │
└─────────────────────┘      └───────────────────┘
```

## Используемые методы из методов_тг_full.md

- web_app_request_fullscreen
- web_app_request_content_safe_area
- web_app_setup_swipe_behavior
- web_app_ready
- web_app_request_theme

## Примечания для тестирования

- Проверить на iOS и Android устройствах
- Проверить на iPhone с челкой для корректности отступов
- Проверить работу на разных версиях Telegram (>=6.1)
- Проверить работу вертикальных свайпов с параметром `allow_vertical_swipe: true`
- Проверить переключение между светлой и темной темами Telegram

## CSS переменные для интеграции с Telegram

### Отступы безопасной зоны
```css
:root {
  --safe-area-top: 30px;
  --safe-area-right: 0px;
  --safe-area-bottom: 0px;
  --safe-area-left: 0px;
  
  /* Альтернативный формат */
  --tg-content-safe-area-top: 30px;
  --tg-content-safe-area-right: 0px;
  --tg-content-safe-area-bottom: 0px;
  --tg-content-safe-area-left: 0px;
}
```

### Параметры темы
```css
:root {
  /* Прямые переменные из Telegram */
  --tg-theme-bg-color: #ffffff;
  --tg-theme-text-color: #000000;
  --tg-theme-hint-color: #999999;
  --tg-theme-link-color: #2481cc;
  --tg-theme-button-color: #2481cc;
  --tg-theme-button-text-color: #ffffff;
  
  /* Упрощенные алиасы */
  --tg-theme-bg: #ffffff;
  --tg-theme-text: #000000;
  --tg-theme-hint: #999999;
  --tg-theme-link: #2481cc;
  --tg-theme-button: #2481cc;
  --tg-theme-button-text: #ffffff;
}
```

# Краткосрочный план: Документирование проекта

**Задача:** Создать детальный `architecture.md`.

**Чеклист:**
- [ ] Создать `docs/TASK.md`.
- [ ] Проанализировать структуру проекта.
- [ ] Описать схему БД (таблицы, поля, связи).
- [ ] Описать логику авторизации (Telegram -> Supabase).
- [ ] Описать маршрутизацию (Next.js App Router).
- [ ] Описать управление состоянием (Context API, Hooks).
- [ ] Описать интеграцию с Telegram Mini App SDK.
- [ ] Описать ключевые компоненты и их назначение.
- [ ] Описать использование переменных окружения.
- [ ] Описать процесс деплоя (Vercel).
- [ ] Описать важные скрипты и файлы.
- [ ] Описать общий поток данных для отображения на главной странице.
- [ ] Добавить структуру файлов в `architecture.md`.
- [ ] Поставить метку последней верификации. 

# КРАТКОСРОЧНЫЙ ПЛАН

## Текущая задача: Рефакторинг page.tsx и устранение ошибок

### Шаги:
1. Исправление ошибки с window is not defined в продакшене
   - Проблема связана с попыткой доступа к window в SSR
   - Необходимо обернуть все обращения к window в проверку typeof window !== 'undefined'

2. Разбиение page.tsx на компоненты:
   - MainContent: основное содержимое приложения
   - AppNavigation: навигационное меню
   - FloatingDebugButton: кнопка вызова отладочной панели
   - TelegramThemeManager: управление темой и CSS-переменными
   - TelegramSafeAreaHandler: обработка событий изменения безопасной зоны
   - LoggingProvider: компонент для расширенного логирования

3. Создание утилит для стилей:
   - cssUtils.ts: безопасное управление CSS-переменными с учетом SSR

### Чеклист выполнения:
- [x] Ошибка "window is not defined" исправлена
- [x] Создан компонент TelegramThemeManager для управления темой
- [x] Создан компонент TelegramSafeAreaHandler для обработки событий
- [x] Создан компонент LoggingProvider для логирования
- [x] Создана утилита cssUtils.ts
- [x] Размер page.tsx уменьшен за счет выделения компонентов
- [x] Все проверки typeof window !== 'undefined' добавлены
- [x] Все проверки typeof document !== 'undefined' добавлены

## Следующие шаги:
1. Тестирование в продакшен среде
2. Дальнейшее разбиение крупных компонентов
3. Улучшение типизации и документирование компонентов

# КРАТКОСРОЧНОЕ ПЛАНИРОВАНИЕ

## Текущая задача
- Настроить корректную авторизацию пользователей с записью в таблицу users
- Исправить проблемы с дебаг-панелью (лаги, ошибки в консоли)
- Добавить в дебаг-панель кнопки быстрого копирования
- Исправить отступы content safe area на главной странице
- Настроить корректное отображение Telegram Mini App в fullscreen режиме
- Использовать web_app_request_fullscreen вместо устаревшего метода expand()
- Обеспечить сохранение данных пользователя в таблице users
- Улучшить функцию createUserInSupabase в TelegramContext.tsx
- Обеспечить надежное создание пользователей в Supabase с учетом ограничений внешних ключей
- Привести код к единому паттерну, используемому в тестовых скриптах
- Улучшить обработку ошибок и логирование процесса создания/обновления пользователя
- Исправить интеграцию с Telegram Mini Apps SDK
- Обеспечить корректное получение данных пользователя из Telegram
- Упростить панель отладки с фокусом на логи и initData
- Реализовать функциональность полно